{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "f00e3570",
   "metadata": {},
   "source": [
    "# Lab 3: Azure AI Foundry Agent Service ê¸°ë°˜ Multi-Agent êµ¬ì¶•\n",
    "\n",
    "## ê°œìš” (Overview)\n",
    "\n",
    "ì´ ë…¸íŠ¸ë¶ì—ì„œëŠ” Azure AI Foundryì˜ Agent Serviceë¥¼ í™œìš©í•˜ì—¬ Multi-Agent ì‹œìŠ¤í…œì„ êµ¬ì¶•í•˜ê³  ë°°í¬í•©ë‹ˆë‹¤.\n",
    "\n",
    "### ì•„í‚¤í…ì²˜ (Architecture)\n",
    "\n",
    "```\n",
    "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n",
    "â”‚                 Multi-Agent System                         â”‚\n",
    "â”‚                                                            â”‚\n",
    "â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚\n",
    "â”‚  â”‚          Main Agent                         â”‚          â”‚\n",
    "â”‚  â”‚  (Task Analysis & Routing)                  â”‚          â”‚\n",
    "â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚\n",
    "â”‚               â”‚                â”‚                           â”‚\n",
    "â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚\n",
    "â”‚       â”‚  Tool Agent  â”‚  â”‚  Research       â”‚               â”‚\n",
    "â”‚       â”‚  (MCP)       â”‚  â”‚  Agent (RAG)    â”‚               â”‚\n",
    "â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚\n",
    "â”‚              â”‚                   â”‚                         â”‚\n",
    "â”‚       â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚\n",
    "â”‚       â”‚  MCP Server  â”‚    â”‚  Azure AI      â”‚              â”‚\n",
    "â”‚       â”‚  (ACA)       â”‚    â”‚  Search (RAG)  â”‚              â”‚\n",
    "â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚\n",
    "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n",
    "```\n",
    "\n",
    "### ì£¼ìš” êµ¬ì„± ìš”ì†Œ (Components)\n",
    "\n",
    "1. **Main Agent**: ì‚¬ìš©ì ìš”ì²­ì„ ë¶„ì„í•˜ê³  ì ì ˆí•œ Agentë¡œ ë¼ìš°íŒ…\n",
    "2. **Tool Agent**: MCP ì„œë²„ì˜ ë„êµ¬ë“¤ì„ í™œìš© (ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´)\n",
    "3. **Research Agent**: Azure AI Searchë¥¼ í†µí•œ ì§€ì‹ ë² ì´ìŠ¤ ê²€ìƒ‰\n",
    "4. **MCP Server**: Azure Container Appsì— ë°°í¬ëœ ë„êµ¬ ì„œë²„\n",
    "\n",
    "### Python ëª¨ë“ˆ êµ¬ì¡° (Python Modules)\n",
    "\n",
    "```\n",
    "src/foundry_agent/\n",
    "â”œâ”€â”€ main_agent.py       - Main Agent í´ë˜ìŠ¤\n",
    "â”œâ”€â”€ tool_agent.py       - Tool Agent í´ë˜ìŠ¤ (MCP)\n",
    "â”œâ”€â”€ research_agent.py   - Research Agent í´ë˜ìŠ¤ (RAG)\n",
    "â”œâ”€â”€ api_server.py       - FastAPI HTTP ì„œë²„ (Agent ì—”ë“œí¬ì¸íŠ¸)\n",
    "â”œâ”€â”€ masking.py          - ë§ˆìŠ¤í‚¹ ìœ í‹¸ë¦¬í‹° (PII ë³´í˜¸)\n",
    "â””â”€â”€ requirements.txt    - Python ì˜ì¡´ì„±\n",
    "```\n",
    "\n",
    "### í•™ìŠµ ëª©í‘œ (Learning Objectives)\n",
    "\n",
    "1. âœ… Azure AI Foundry Agent Service ì´í•´ ë° í™œìš©\n",
    "2. âœ… MCP Serverë¥¼ Azure Container Appsì— ë°°í¬\n",
    "3. âœ… Connected Agentë¥¼ ì‚¬ìš©í•œ MCP ì—°ë™\n",
    "4. âœ… Multi-Agent ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ íŒ¨í„´ êµ¬í˜„\n",
    "5. âœ… RAG ê¸°ë°˜ Agent êµ¬ì¶•\n",
    "6. âœ… Agent ê°„ í˜‘ì—… ë° ì‘ë‹µ í†µí•©"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a45fa842",
   "metadata": {},
   "source": [
    "## 1. í™˜ê²½ ì„¤ì • ë° ì¸ì¦ (Setup & Authentication)\n",
    "\n",
    "### í…Œë„ŒíŠ¸ ID ì„¤ì • ì•ˆë‚´\n",
    "\n",
    "**ëŒ€ë¶€ë¶„ì˜ ê²½ìš°**: í…Œë„ŒíŠ¸ IDë¥¼ ì§€ì •í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤. `tenant_id` ë³€ìˆ˜ë¥¼ `\"<YOUR_TENANT_ID>\"` ë˜ëŠ” `None`ìœ¼ë¡œ ë‘ê³  ì‹¤í–‰í•˜ì„¸ìš”.\n",
    "\n",
    "**í…Œë„ŒíŠ¸ IDê°€ í•„ìš”í•œ ê²½ìš°**:\n",
    "- âœ… ì—¬ëŸ¬ ì¡°ì§(íšŒì‚¬)ì˜ Azure í…Œë„ŒíŠ¸ì— ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ê²½ìš°\n",
    "- âœ… íŠ¹ì • ì¡°ì§ì˜ ë¦¬ì†ŒìŠ¤ë¡œë§Œ ì‘ì—…í•´ì•¼ í•˜ëŠ” ê²½ìš°\n",
    "- âœ… ë¡œê·¸ì¸ ì‹œ \"multiple tenants\" ê´€ë ¨ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°\n",
    "\n",
    "**í…Œë„ŒíŠ¸ ID í™•ì¸ ë°©ë²•**:\n",
    "- Azure Portal â†’ Azure Active Directory â†’ ê°œìš” â†’ í…Œë„ŒíŠ¸ ID ë³µì‚¬\n",
    "- ë˜ëŠ” ì¡°ì§ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "e6295d4c",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Prerequisites Check ===\n",
      "âœ“ Python 3.12.12 (Darwin)\n",
      "âœ“ Azure CLI\n",
      "âœ“ Docker\n",
      "==================================================\n"
     ]
    }
   ],
   "source": [
    "import sys, subprocess, os, json\n",
    "import platform\n",
    "\n",
    "# ìš´ì˜ì²´ì œì— ë”°ë¼ PATH ì„¤ì •\n",
    "system = platform.system()\n",
    "if system == 'Darwin':  # macOS\n",
    "    extra_paths = '/opt/homebrew/bin:/usr/local/bin'\n",
    "elif system == 'Linux':  # Linux / Codespaces\n",
    "    extra_paths = '/usr/local/bin:/usr/bin:/home/codespace/.local/bin'\n",
    "else:  # Windows\n",
    "    extra_paths = ''\n",
    "\n",
    "if extra_paths:\n",
    "    os.environ['PATH'] = extra_paths + ':' + os.environ.get('PATH', '')\n",
    "\n",
    "def check(cmd, name):\n",
    "    try:\n",
    "        result = subprocess.run(cmd, shell=True, capture_output=True, timeout=3, env=os.environ)\n",
    "        print(f\"{'âœ“' if result.returncode == 0 else 'âœ—'} {name}\")\n",
    "    except Exception as e:\n",
    "        print(f\"âœ— {name}\")\n",
    "\n",
    "print(\"=== Prerequisites Check ===\")\n",
    "print(f\"âœ“ Python {sys.version.split()[0]} ({system})\")\n",
    "check(\"az --version\", \"Azure CLI\")\n",
    "check(\"docker --version\", \"Docker\")\n",
    "print(\"=\"*50)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "00fd9d7b",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Azure Authentication ===\n",
      "â„¹ï¸  ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.\n",
      "\n",
      "âœ… Azure CLI ì¸ì¦ ì™„ë£Œ (ê¸°ì¡´ ì„¸ì…˜ ì‚¬ìš©)\n",
      "   êµ¬ë…: Visual Studio Enterprise Subscription\n",
      "   í…Œë„ŒíŠ¸: 2e8663e8-e15f-4dd9-b617-0cfc4f82adca\n",
      "==================================================\n"
     ]
    }
   ],
   "source": [
    "import subprocess, json\n",
    "\n",
    "print(\"=== Azure Authentication ===\")\n",
    "print(\"â„¹ï¸  ì¸ì¦ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.\\n\")\n",
    "\n",
    "# í…Œë„ŒíŠ¸ IDë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)\n",
    "# ì˜ˆ: tenant_id = \"16b3c013-d300-468d-ac64-7eda0820b6d3\"\n",
    "tenant_id = \"<YOUR_TENANT_ID>\"  # ë˜ëŠ” Noneìœ¼ë¡œ ì„¤ì •í•˜ë©´ ê¸°ë³¸ í…Œë„ŒíŠ¸ ì‚¬ìš©\n",
    "\n",
    "# Azure CLI ì¸ì¦ ìƒíƒœ í™•ì¸\n",
    "az_account = subprocess.run(\"az account show\", shell=True, capture_output=True, text=True)\n",
    "\n",
    "if az_account.returncode == 0:\n",
    "    account_info = json.loads(az_account.stdout)\n",
    "    print(f\"âœ… Azure CLI ì¸ì¦ ì™„ë£Œ (ê¸°ì¡´ ì„¸ì…˜ ì‚¬ìš©)\")\n",
    "    print(f\"   êµ¬ë…: {account_info.get('name', 'N/A')}\")\n",
    "    print(f\"   í…Œë„ŒíŠ¸: {account_info.get('tenantId', 'N/A')}\")\n",
    "else:\n",
    "    print(\"âš ï¸  Azure CLI ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ê°€ ì—´ë¦½ë‹ˆë‹¤...\")\n",
    "    # í…Œë„ŒíŠ¸ IDê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ í…Œë„ŒíŠ¸ë¡œ ë¡œê·¸ì¸\n",
    "    if tenant_id and tenant_id != \"<YOUR_TENANT_ID>\":\n",
    "        az_login = subprocess.run(f\"az login --tenant {tenant_id}\", shell=True)\n",
    "    else:\n",
    "        az_login = subprocess.run(\"az login\", shell=True)\n",
    "    \n",
    "    if az_login.returncode == 0:\n",
    "        print(\"âœ… Azure CLI ë¡œê·¸ì¸ ì™„ë£Œ\")\n",
    "    else:\n",
    "        raise Exception(\"âŒ Azure CLI ë¡œê·¸ì¸ ì‹¤íŒ¨\")\n",
    "\n",
    "print(\"=\"*50)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "857588b7",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Configuration Loaded ===\n",
      "Resource Group: rg-aiagent-4sfcl5\n",
      "Location: eastus\n",
      "Search Index: ai-agent-knowledge-base\n",
      "Container Registry: crf5gn2xuprfeyy.azurecr.io\n",
      "==================================================\n"
     ]
    }
   ],
   "source": [
    "# ì„¤ì • íŒŒì¼ ë¡œë“œ\n",
    "config_path = \"config.json\"\n",
    "with open(config_path) as f:\n",
    "    config = json.load(f)\n",
    "\n",
    "# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •\n",
    "RESOURCE_GROUP = config[\"resource_group\"]\n",
    "LOCATION = config[\"location\"]\n",
    "PROJECT_CONNECTION_STRING = config[\"project_connection_string\"]\n",
    "SEARCH_ENDPOINT = config[\"search_endpoint\"]\n",
    "SEARCH_INDEX = config[\"search_index\"]\n",
    "CONTAINER_REGISTRY = config[\"container_registry_endpoint\"]\n",
    "CONTAINER_ENV_ID = config[\"container_apps_environment_id\"]\n",
    "\n",
    "# PROJECT_CONNECTION_STRINGì„ ê°„ë‹¨í•œ í˜•ì‹ìœ¼ë¡œ ë³€í™˜\n",
    "# config.json í˜•ì‹: https://xxx/api/projects/yyy;subscription_id=zzz;resource_group=www\n",
    "# í•„ìš”í•œ í˜•ì‹: https://xxx/api/projects/yyy (ì„¸ë¯¸ì½œë¡  ì´í›„ ì œê±°)\n",
    "simple_project_conn = PROJECT_CONNECTION_STRING.split(';')[0] if PROJECT_CONNECTION_STRING else \"\"\n",
    "\n",
    "print(\"=== Configuration Loaded ===\")\n",
    "print(f\"Resource Group: {RESOURCE_GROUP}\")\n",
    "print(f\"Location: {LOCATION}\")\n",
    "print(f\"Search Index: {SEARCH_INDEX}\")\n",
    "print(f\"Container Registry: {CONTAINER_REGISTRY}\")\n",
    "print(\"=\"*50)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0e705908",
   "metadata": {},
   "source": [
    "## 2. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Install Required Packages)\n",
    "\n",
    "Azure AI ê´€ë ¨ í•„ìˆ˜ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤. GitHub Codespaceì—ì„œ ì‹¤í–‰í•˜ëŠ” ê²½ìš° ëŒ€ë¶€ë¶„ì˜ íŒ¨í‚¤ì§€ê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "1f82e709",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Installing Required Packages ===\n",
      "\n",
      "Installing azure-ai-projects...\n",
      "âœ… azure-ai-projects installed\n",
      "Installing azure-ai-evaluation...\n",
      "âœ… azure-ai-evaluation installed\n",
      "Installing azure-ai-inference...\n",
      "âœ… azure-ai-inference installed\n",
      "Installing azure-search-documents...\n",
      "âœ… azure-search-documents installed\n",
      "Installing azure-identity...\n",
      "âœ… azure-identity installed\n",
      "Installing openai...\n",
      "âœ… openai installed\n",
      "Installing python-dotenv...\n",
      "âœ… python-dotenv installed\n",
      "Installing requests...\n",
      "âœ… requests installed\n",
      "\n",
      "==================================================\n",
      "âœ… Package installation completed!\n"
     ]
    }
   ],
   "source": [
    "# í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜\n",
    "import subprocess\n",
    "import sys\n",
    "\n",
    "packages = [\n",
    "    \"azure-ai-projects\",\n",
    "    \"azure-ai-evaluation\",\n",
    "    \"azure-ai-inference\",\n",
    "    \"azure-search-documents\",\n",
    "    \"azure-identity\",\n",
    "    \"openai\",\n",
    "    \"python-dotenv\",\n",
    "    \"requests\"\n",
    "]\n",
    "\n",
    "print(\"=== Installing Required Packages ===\\n\")\n",
    "\n",
    "for package in packages:\n",
    "    print(f\"Installing {package}...\")\n",
    "    result = subprocess.run(\n",
    "        [sys.executable, \"-m\", \"pip\", \"install\", \"-q\", package],\n",
    "        capture_output=True,\n",
    "        text=True\n",
    "    )\n",
    "    if result.returncode == 0:\n",
    "        print(f\"âœ… {package} installed\")\n",
    "    else:\n",
    "        print(f\"âš ï¸  {package} may already be installed or failed to install\")\n",
    "\n",
    "print(\"\\n\" + \"=\"*50)\n",
    "print(\"âœ… Package installation completed!\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b84530d7",
   "metadata": {},
   "source": [
    "## 3. Azure AI Search í‚¤ ê°€ì ¸ì˜¤ê¸° (Get Search Key)\n",
    "\n",
    "RAG Agentê°€ ì‚¬ìš©í•  Azure AI Search ê´€ë¦¬ í‚¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "35b0ebf5",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "âœ… Search key retrieved: X6UoYcyAxt...\n"
     ]
    }
   ],
   "source": [
    "# AI Search ê´€ë¦¬ í‚¤ ê°€ì ¸ì˜¤ê¸°\n",
    "search_name = config[\"search_service_name\"]\n",
    "\n",
    "search_key_cmd = f\"\"\"\n",
    "az search admin-key show \\\n",
    "    --resource-group {RESOURCE_GROUP} \\\n",
    "    --service-name {search_name} \\\n",
    "    --query primaryKey -o tsv\n",
    "\"\"\"\n",
    "\n",
    "result = subprocess.run(search_key_cmd, shell=True, capture_output=True, text=True)\n",
    "SEARCH_KEY = result.stdout.strip()\n",
    "\n",
    "if SEARCH_KEY:\n",
    "    print(f\"âœ… Search key retrieved: {SEARCH_KEY[:10]}...\")\n",
    "    os.environ['SEARCH_KEY'] = SEARCH_KEY\n",
    "else:\n",
    "    print(\"âŒ Failed to retrieve search key\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3063a53c",
   "metadata": {},
   "source": [
    "## 4. Azure AI Search ì—°ê²° ì¶”ê°€ (Add Azure AI Search Connection)\n",
    "\n",
    "Azure AI Foundry í”„ë¡œì íŠ¸ì— Azure AI Search ì—°ê²°ì„ ì¶”ê°€í•©ë‹ˆë‹¤.\n",
    "\n",
    "**ì—°ê²° ì¶”ê°€ ì´ìœ :**\n",
    "- `AzureAISearchTool`ì€ í”„ë¡œì íŠ¸ ì—°ê²°ì„ í†µí•´ Azure AI Searchì— ì•¡ì„¸ìŠ¤í•©ë‹ˆë‹¤\n",
    "- ì—°ê²°ì´ ì—†ìœ¼ë©´ Research Agentê°€ RAG ê¸°ëŠ¥ ì—†ì´ ì¼ë°˜ ì§€ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•©ë‹ˆë‹¤\n",
    "\n",
    "**ì‘ì—… ë‚´ìš©:**\n",
    "- Azure AI Search ì„œë¹„ìŠ¤ ì •ë³´ë¥¼ í”„ë¡œì íŠ¸ì— ì—°ê²°ë¡œ ë“±ë¡\n",
    "- ë“±ë¡ í›„ Research Agentê°€ ìë™ìœ¼ë¡œ ì—°ê²°ì„ ì‚¬ìš©í•˜ì—¬ RAG ìˆ˜í–‰"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "16a29169",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Checking Azure AI Search Connection ===\n",
      "\n",
      "ğŸ” Project: https://aoai-f5gn2xuprfeyy.services.ai.azure.com/api/projects/proj-f5gn2xuprfeyy\n",
      "\n",
      "ğŸ“‹ Checking existing connections...\n",
      "\n",
      "âœ… Default Azure AI Search connection found!\n",
      "   Connection ID: /subscriptions/8627ae60-01d3-4a2d-9c33-89dea54cd4b4/resourceGroups/rg-aiagent-4sfcl5/providers/Microsoft.CognitiveServices/accounts/aoai-f5gn2xuprfeyy/projects/proj-f5gn2xuprfeyy/connections/srchf5gn2xuprfeyy\n",
      "   Connection Name: srchf5gn2xuprfeyy\n",
      "\n",
      "============================================================\n",
      "âœ… Azure AI Search connection is configured!\n",
      "\n",
      "ğŸ’¡ Research Agent will use RAG with this connection.\n",
      "   You can now test the Research Agent.\n",
      "\n",
      "============================================================\n"
     ]
    }
   ],
   "source": [
    "# Azure AI Search ì—°ê²° í™•ì¸\n",
    "from azure.ai.projects import AIProjectClient\n",
    "from azure.ai.projects.models import ConnectionType\n",
    "from azure.identity import DefaultAzureCredential\n",
    "\n",
    "print(\"=== Checking Azure AI Search Connection ===\\n\")\n",
    "\n",
    "# Initialize project client\n",
    "print(f\"ğŸ” Project: {simple_project_conn}\\n\")\n",
    "\n",
    "project_client_for_connection = AIProjectClient(\n",
    "    endpoint=simple_project_conn,\n",
    "    credential=DefaultAzureCredential()\n",
    ")\n",
    "\n",
    "# Check existing connections\n",
    "print(\"ğŸ“‹ Checking existing connections...\\n\")\n",
    "\n",
    "connection_exists = False\n",
    "\n",
    "try:\n",
    "    # Try to get default Azure AI Search connection\n",
    "    search_connection = project_client_for_connection.connections.get_default(\n",
    "        connection_type=ConnectionType.AZURE_AI_SEARCH\n",
    "    )\n",
    "    print(f\"âœ… Default Azure AI Search connection found!\")\n",
    "    print(f\"   Connection ID: {search_connection.id}\")\n",
    "    print(f\"   Connection Name: {search_connection.name}\\n\")\n",
    "    connection_exists = True\n",
    "    \n",
    "except Exception as e:\n",
    "    print(f\"âš ï¸  No default connection found: {e}\\n\")\n",
    "    \n",
    "    # Try to list all Azure AI Search connections\n",
    "    try:\n",
    "        print(\"ğŸ” Searching for any Azure AI Search connections...\")\n",
    "        connections = list(project_client_for_connection.connections.list(\n",
    "            connection_type=ConnectionType.AZURE_AI_SEARCH\n",
    "        ))\n",
    "        \n",
    "        if connections:\n",
    "            print(f\"âœ… Found {len(connections)} Azure AI Search connection(s):\\n\")\n",
    "            for conn in connections:\n",
    "                print(f\"   â€¢ {conn.name}\")\n",
    "                print(f\"     ID: {conn.id}\\n\")\n",
    "            connection_exists = True\n",
    "        else:\n",
    "            print(\"âŒ No Azure AI Search connections found\\n\")\n",
    "            \n",
    "    except Exception as e2:\n",
    "        print(f\"âŒ Error listing connections: {e2}\\n\")\n",
    "\n",
    "# Display result\n",
    "print(\"=\"*60)\n",
    "if connection_exists:\n",
    "    print(\"âœ… Azure AI Search connection is configured!\")\n",
    "    print(\"\\nğŸ’¡ Research Agent will use RAG with this connection.\")\n",
    "    print(\"   You can now test the Research Agent.\\n\")\n",
    "else:\n",
    "    print(\"âŒ No Azure AI Search connection found\")\n",
    "    print(\"\\nğŸ“ Please add the connection via Azure Portal:\")\n",
    "    print(\"   1. Go to: https://ai.azure.com\")\n",
    "    print(f\"   2. Open project: {simple_project_conn.split('/')[-1]}\")\n",
    "    print(\"   3. Settings â†’ Connections â†’ + New connection\")\n",
    "    print(\"   4. Select: Azure AI Search\")\n",
    "    print(f\"   5. Configure with endpoint: {SEARCH_ENDPOINT}\\n\")\n",
    "\n",
    "print(\"=\"*60)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "85824c72",
   "metadata": {},
   "source": [
    "## 5. MCP Server ë°°í¬ (Deploy MCP Server)\n",
    "\n",
    "Model Context Protocol ì„œë²„ë¥¼ Azure Container Appsì— ë°°í¬í•©ë‹ˆë‹¤.\n",
    "\n",
    "### MCP Server ê¸°ëŠ¥\n",
    "- `get_weather`: ë„ì‹œë³„ ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´ ì¡°íšŒ\n",
    "  - ë°ì´í„° ì†ŒìŠ¤: wttr.in API (ë¬´ë£Œ, ì‹ ë¢°ì„± ë†’ìŒ)\n",
    "  - ì§€ì› ì–¸ì–´: í•œê¸€/ì˜ì–´ ë„ì‹œëª… ëª¨ë‘ ê°€ëŠ¥ (ì˜ˆ: 'Seoul', 'ì„œìš¸')\n",
    "  - ì œê³µ ì •ë³´: ì˜¨ë„, ì²´ê°ì˜¨ë„, ë‚ ì”¨ìƒíƒœ, ìŠµë„, í’ì†/í’í–¥, ê´€ì¸¡ì‹œê°„\n",
    "\n",
    "### ì„œë²„ êµ¬ì„±\n",
    "- **í”„ë¡œí† ì½œ**: Streamable HTTP (MCP over HTTP with SSE)\n",
    "- **í¬íŠ¸**: 8000\n",
    "- **ì—”ë“œí¬ì¸íŠ¸**:\n",
    "  - `POST /mcp` - MCP message handling (Server-Sent Events)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "f8fbcf70",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Container Registry Login ===\n",
      "âœ… Logged in to crf5gn2xuprfeyy\n",
      "\n",
      "ğŸ’¡ MCP ì„œë²„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì…€ì—ì„œ ì¬ë¹Œë“œí•˜ì„¸ìš”.\n",
      "==================================================\n"
     ]
    }
   ],
   "source": [
    "# Container Registryì— ë¡œê·¸ì¸ (ì¬ë°°í¬ë¥¼ ìœ„í•´)\n",
    "registry_name = CONTAINER_REGISTRY.split('.')[0]\n",
    "\n",
    "print(\"=== Container Registry Login ===\")\n",
    "login_cmd = f\"az acr login --name {registry_name}\"\n",
    "result = subprocess.run(login_cmd, shell=True, capture_output=True, text=True)\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(f\"âœ… Logged in to {registry_name}\")\n",
    "    print(\"\\nğŸ’¡ MCP ì„œë²„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì…€ì—ì„œ ì¬ë¹Œë“œí•˜ì„¸ìš”.\")\n",
    "else:\n",
    "    print(f\"âŒ Login failed: {result.stderr}\")\n",
    "print(\"=\"*50)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "f89b21b1",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Creating .env file for MCP Server ===\n",
      "\n",
      "âœ… Created src/mcp/.env\n",
      "\n",
      "ğŸ’¡ MCP ì„œë²„ëŠ” í˜„ì¬ í™˜ê²½ ë³€ìˆ˜ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n",
      "   í•˜ì§€ë§Œ í–¥í›„ ì™¸ë¶€ API ì—°ë™ ì‹œ ì´ íŒŒì¼ì— ì„¤ì •ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n",
      "\n",
      "============================================================\n"
     ]
    }
   ],
   "source": [
    "# .env íŒŒì¼ ìƒì„± (MCP Serverìš© - í–¥í›„ í™•ì¥ì„±ì„ ìœ„í•´)\n",
    "print(\"=== Creating .env file for MCP Server ===\\n\")\n",
    "\n",
    "# MCP ì„œë²„ëŠ” í˜„ì¬ í™˜ê²½ ë³€ìˆ˜ê°€ í•„ìš”í•˜ì§€ ì•Šì§€ë§Œ, í–¥í›„ í™•ì¥ì„ ìœ„í•´ ë¹ˆ íŒŒì¼ ìƒì„±\n",
    "env_content = \"\"\"# MCP Server Configuration\n",
    "# Add any configuration variables here as needed\n",
    "\n",
    "# Example: API keys, endpoints, etc.\n",
    "# WEATHER_API_KEY=your_api_key_here\n",
    "# EXTERNAL_SERVICE_URL=your_service_url_here\n",
    "\"\"\"\n",
    "\n",
    "env_file_path = \"src/mcp/.env\"\n",
    "\n",
    "try:\n",
    "    with open(env_file_path, 'w') as f:\n",
    "        f.write(env_content)\n",
    "    \n",
    "    print(f\"âœ… Created {env_file_path}\")\n",
    "    print(\"\\nğŸ’¡ MCP ì„œë²„ëŠ” í˜„ì¬ í™˜ê²½ ë³€ìˆ˜ê°€ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\")\n",
    "    print(\"   í•˜ì§€ë§Œ í–¥í›„ ì™¸ë¶€ API ì—°ë™ ì‹œ ì´ íŒŒì¼ì— ì„¤ì •ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\")\n",
    "    \n",
    "except Exception as e:\n",
    "    print(f\"âŒ Failed to create .env file: {e}\")\n",
    "\n",
    "print(\"\\n\" + \"=\"*60)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "1a8af0a4",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Building MCP Server Image ===\n",
      "Image: crf5gn2xuprfeyy.azurecr.io/mcp-server:latest\n",
      "\n",
      "ğŸ”¨ Building image (linux/amd64)...\n",
      "âœ… Build successful (2.1s)\n",
      "\n",
      "ğŸ“¤ Pushing image to registry...\n",
      "âœ… Push successful\n",
      "==================================================\n"
     ]
    }
   ],
   "source": [
    "# MCP Server ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ\n",
    "import time\n",
    "\n",
    "mcp_image = f\"{CONTAINER_REGISTRY}/mcp-server:latest\"\n",
    "\n",
    "print(\"=== Building MCP Server Image ===\")\n",
    "print(f\"Image: {mcp_image}\\n\")\n",
    "\n",
    "# ë¹Œë“œ (Azure Container Appsìš© linux/amd64 í”Œë«í¼)\n",
    "build_cmd = f\"docker build --platform linux/amd64 -t {mcp_image} ./src/mcp\"\n",
    "print(\"ğŸ”¨ Building image (linux/amd64)...\")\n",
    "start_time = time.time()\n",
    "\n",
    "result = subprocess.run(build_cmd, shell=True, capture_output=True, text=True)\n",
    "elapsed = time.time() - start_time\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(f\"âœ… Build successful ({elapsed:.1f}s)\")\n",
    "else:\n",
    "    print(f\"âŒ Build failed: {result.stderr}\")\n",
    "    \n",
    "# í‘¸ì‹œ\n",
    "if result.returncode == 0:\n",
    "    print(\"\\nğŸ“¤ Pushing image to registry...\")\n",
    "    push_cmd = f\"docker push {mcp_image}\"\n",
    "    result = subprocess.run(push_cmd, shell=True, capture_output=True, text=True)\n",
    "    \n",
    "    if result.returncode == 0:\n",
    "        print(f\"âœ… Push successful\")\n",
    "    else:\n",
    "        print(f\"âŒ Push failed: {result.stderr}\")\n",
    "\n",
    "print(\"=\"*50)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "6c6e4a41",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Deploying MCP Server to ACA ===\n",
      "App Name: mcp-server\n",
      "\n",
      "ğŸš€ Deploying...\n",
      "âœ… Deployment successful\n",
      "\n",
      "ğŸŒ MCP Endpoint: https://mcp-server.gentletree-a093330c.eastus.azurecontainerapps.io\n",
      "âœ… Config updated\n",
      "==================================================\n"
     ]
    }
   ],
   "source": [
    "# MCP Serverë¥¼ Container Appìœ¼ë¡œ ë°°í¬\n",
    "mcp_app_name = \"mcp-server\"\n",
    "\n",
    "print(\"=== Deploying MCP Server to ACA ===\")\n",
    "print(f\"App Name: {mcp_app_name}\\n\")\n",
    "\n",
    "deploy_cmd = f\"\"\"\n",
    "az containerapp create \\\n",
    "    --name {mcp_app_name} \\\n",
    "    --resource-group {RESOURCE_GROUP} \\\n",
    "    --environment {CONTAINER_ENV_ID.split('/')[-1]} \\\n",
    "    --image {mcp_image} \\\n",
    "    --target-port 8000 \\\n",
    "    --ingress external \\\n",
    "    --min-replicas 1 \\\n",
    "    --max-replicas 3 \\\n",
    "    --cpu 0.5 \\\n",
    "    --memory 1.0Gi \\\n",
    "    --registry-server {CONTAINER_REGISTRY}\n",
    "\"\"\"\n",
    "\n",
    "print(\"ğŸš€ Deploying...\")\n",
    "result = subprocess.run(deploy_cmd, shell=True, capture_output=True, text=True)\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(\"âœ… Deployment successful\")\n",
    "    \n",
    "    # Get endpoint\n",
    "    show_cmd = f\"\"\"\n",
    "    az containerapp show \\\n",
    "        --name {mcp_app_name} \\\n",
    "        --resource-group {RESOURCE_GROUP} \\\n",
    "        --query properties.configuration.ingress.fqdn -o tsv\n",
    "    \"\"\"\n",
    "    result = subprocess.run(show_cmd, shell=True, capture_output=True, text=True)\n",
    "    MCP_ENDPOINT = f\"https://{result.stdout.strip()}\"\n",
    "    \n",
    "    print(f\"\\nğŸŒ MCP Endpoint: {MCP_ENDPOINT}\")\n",
    "    \n",
    "    # Update config\n",
    "    config['mcp_endpoint'] = MCP_ENDPOINT\n",
    "    with open(config_path, 'w') as f:\n",
    "        json.dump(config, f, indent=2)\n",
    "    print(\"âœ… Config updated\")\n",
    "else:\n",
    "    print(f\"âŒ Deployment failed: {result.stderr}\")\n",
    "    MCP_ENDPOINT = None\n",
    "\n",
    "print(\"=\"*50)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ccfa3dfe",
   "metadata": {},
   "source": [
    "## 6. Agent Container ë¹Œë“œ ë° ë°°í¬ (Build & Deploy Agent Container)\n",
    "\n",
    "Agentë“¤ì„ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ê³  Azure Container Appsì— ë°°í¬í•©ë‹ˆë‹¤.\n",
    "\n",
    "### ì»¨í…Œì´ë„ˆì— í¬í•¨ëœ Agent ëª¨ë“ˆ\n",
    "\n",
    "- `main_agent.py` - Main Agent í´ë˜ìŠ¤\n",
    "- `tool_agent.py` - Tool Agent í´ë˜ìŠ¤ \n",
    "- `research_agent.py` - Research Agent í´ë˜ìŠ¤\n",
    "- `api_server.py` - FastAPI ê¸°ë°˜ HTTP API ì„œë²„\n",
    "- `masking.py` - ë§ˆìŠ¤í‚¹ ìœ í‹¸ë¦¬í‹° (PII ë³´í˜¸)\n",
    "\n",
    "### ì„œë²„ êµ¬ì„±\n",
    "\n",
    "- **í”„ë ˆì„ì›Œí¬**: FastAPI\n",
    "- **í¬íŠ¸**: 8000\n",
    "- **ì—”ë“œí¬ì¸íŠ¸**:\n",
    "  - `/health` - Health check\n",
    "  - `/` - Root (Agent ìƒíƒœ ì •ë³´)\n",
    "  - `/chat` - Agent ëŒ€í™” ì—”ë“œí¬ì¸íŠ¸ (POST)\n",
    "\n",
    "### MCP ì„œë²„ ì œê³µ ê¸°ëŠ¥\n",
    "\n",
    "- **ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´**:\n",
    "  - `get_weather(location)` - ì „ ì„¸ê³„ ë„ì‹œì˜ ì •í™•í•œ ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´\n",
    "  - ë°ì´í„° ì†ŒìŠ¤: wttr.in API (ë¬´ë£Œ, ì‹ ë¢°ì„± ë†’ìŒ)\n",
    "  - ì§€ì› ì–¸ì–´: í•œê¸€/ì˜ì–´ ë„ì‹œëª… ëª¨ë‘ ê°€ëŠ¥ (ì˜ˆ: 'Seoul', 'ì„œìš¸')\n",
    "  - ì œê³µ ì •ë³´: ì˜¨ë„, ì²´ê°ì˜¨ë„, ë‚ ì”¨ìƒíƒœ, ìŠµë„, í’ì†/í’í–¥, ê´€ì¸¡ì‹œê°„\n",
    "\n",
    "### í™˜ê²½ ë³€ìˆ˜ ì„¤ì •\n",
    "\n",
    "`.env` íŒŒì¼ì— ë‹¤ìŒ ë³€ìˆ˜ë“¤ì´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤:\n",
    "\n",
    "- `PROJECT_CONNECTION_STRING` - Azure AI Foundry í”„ë¡œì íŠ¸ ì—°ê²° ë¬¸ìì—´\n",
    "- `SEARCH_ENDPOINT`, `SEARCH_KEY`, `SEARCH_INDEX` - Azure AI Search ì„¤ì •\n",
    "- `MCP_ENDPOINT` - MCP Server ì—”ë“œí¬ì¸íŠ¸\n",
    "- `APPLICATIONINSIGHTS_CONNECTION_STRING` - Application Insights ì—°ê²° (Application Analyticsìš©)\n",
    "- `OTEL_SERVICE_NAME`, `OTEL_TRACES_EXPORTER`, `OTEL_METRICS_EXPORTER`, `OTEL_LOGS_EXPORTER`, `OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED` - OpenTelemetry ì„¤ì • (Tracingìš©)\n",
    "- `AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED` - Prompt/Completion ê¸°ë¡ í™œì„±í™” (Tracing UIìš©)\n",
    "- `AGENT_MASKING_MODE` - ë§ˆìŠ¤í‚¹ ê°•ë„ ì„¤ì • (off/standard/strict)\n",
    "\n",
    "### ë°°í¬ ì•„í‚¤í…ì²˜\n",
    "\n",
    "```\n",
    "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n",
    "â”‚      Azure Container Apps Environment               â”‚\n",
    "â”‚                                                     â”‚\n",
    "â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚\n",
    "â”‚  â”‚  MCP Server      â”‚  â”‚  Agent Service       â”‚   â”‚\n",
    "â”‚  â”‚  (Weather API)   â”‚  â”‚  (Multi-Agent)       â”‚   â”‚\n",
    "â”‚  â”‚  :8000           â”‚  â”‚  :8000               â”‚   â”‚\n",
    "â”‚  â”‚                  â”‚  â”‚                      â”‚   â”‚\n",
    "â”‚  â”‚  â€¢ get_weather() â”‚  â”‚  â€¢ Main Agent        â”‚   â”‚\n",
    "â”‚  â”‚                  â”‚  â”‚  â€¢ Tool Agent â”€â”€â”€â”€â”  â”‚   â”‚\n",
    "â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â€¢ Research Agent â”‚  â”‚   â”‚\n",
    "â”‚          â–²             â”‚                   â”‚  â”‚   â”‚\n",
    "â”‚          â”‚             â”‚                   â”‚  â”‚   â”‚\n",
    "â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚\n",
    "â”‚                        â”‚                      â”‚   â”‚\n",
    "â”‚                        â”‚  + Azure AI Search   â”‚   â”‚\n",
    "â”‚                        â”‚  + Azure OpenAI      â”‚   â”‚\n",
    "â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚\n",
    "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n",
    "```"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "3ff91932",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Creating .env file for Agent Container ===\n",
      "\n",
      "ğŸ“Š Getting Application Insights connection string...\n",
      "âœ… Application Insights connection string retrieved\n",
      "\n",
      "ğŸ“¦ Model Configuration:\n",
      "   Deployment Name: gpt-4o\n",
      "   Model Version: 2024-11-20\n",
      "   Capacity (TPM): 50\n",
      "   (from config.json - set in Lab 1 infrastructure deployment)\n",
      "\n",
      "âœ… Created src/foundry_agent/.env\n",
      "\n",
      "ğŸ“‹ Environment variables:\n",
      "   â€¢ PROJECT_CONNECTION_STRING\n",
      "   â€¢ AZURE_AI_MODEL_DEPLOYMENT_NAME\n",
      "   â€¢ AZURE_AI_MODEL_VERSION\n",
      "   â€¢ SEARCH_ENDPOINT\n",
      "   â€¢ SEARCH_KEY\n",
      "   â€¢ SEARCH_INDEX\n",
      "   â€¢ MCP_ENDPOINT\n",
      "   â€¢ APPLICATIONINSIGHTS_CONNECTION_STRING\n",
      "   â€¢ OTEL_SERVICE_NAME\n",
      "   â€¢ OTEL_TRACES_EXPORTER\n",
      "   â€¢ OTEL_METRICS_EXPORTER\n",
      "   â€¢ OTEL_LOGS_EXPORTER\n",
      "   â€¢ OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED\n",
      "   â€¢ AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED\n",
      "   â€¢ AGENT_MASKING_MODE\n",
      "\n",
      "ğŸ’¡ ì´ íŒŒì¼ì€ Docker ì´ë¯¸ì§€ì— í¬í•¨ë©ë‹ˆë‹¤.\n",
      "   ë°°í¬ ì‹œ ë³„ë„ì˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n",
      "\n",
      "âœ… Application Insights ì„¤ì • ì™„ë£Œ!\n",
      "   â†’ Application Analyticsì—ì„œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n",
      "   â†’ OpenTelemetry Tracing ì„¤ì • ì™„ë£Œ!\n",
      "   â†’ GenAI content recording í™œì„±í™” (Input/Output ê¸°ë¡ ì‹œë„)\n",
      "\n",
      "ğŸ” Masking Mode: standard (AGENT_MASKING_MODE ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥)\n",
      "ğŸ¤– Model: gpt-4o (version 2024-11-20, capacity 50K TPM)\n",
      "\n",
      "============================================================\n"
     ]
    }
   ],
   "source": [
    "# .env íŒŒì¼ ìƒì„± (Agent Containerì— í¬í•¨ë  í™˜ê²½ ë³€ìˆ˜)\n",
    "print(\"=== Creating .env file for Agent Container ===\\n\")\n",
    "\n",
    "# 1. Application Insights Connection String ê°€ì ¸ì˜¤ê¸°\n",
    "print(\"ğŸ“Š Getting Application Insights connection string...\")\n",
    "appinsights_cmd = f\"\"\"\n",
    "az monitor app-insights component show \\\n",
    "    --resource-group {RESOURCE_GROUP} \\\n",
    "    --query \"[0].connectionString\" -o tsv\n",
    "\"\"\"\n",
    "\n",
    "result = subprocess.run(appinsights_cmd, shell=True, capture_output=True, text=True)\n",
    "\n",
    "if result.returncode == 0 and result.stdout.strip():\n",
    "    APP_INSIGHTS_CONN_STR = result.stdout.strip()\n",
    "    print(f\"âœ… Application Insights connection string retrieved\\n\")\n",
    "else:\n",
    "    print(f\"âš ï¸  Could not get Application Insights connection string\")\n",
    "    print(f\"   Error: {result.stderr}\")\n",
    "    print(f\"   Proceeding without Application Insights (Analytics will not work)\\n\")\n",
    "    APP_INSIGHTS_CONN_STR = \"\"\n",
    "\n",
    "# 2. ëª¨ë¸ ì„¤ì • ê°€ì ¸ì˜¤ê¸° (config.jsonì—ì„œ)\n",
    "model_deployment_name = config.get(\"model_deployment_name\", \"gpt-4o\")\n",
    "model_version = config.get(\"model_version\", \"2024-11-20\")\n",
    "model_capacity = config.get(\"model_capacity\", 50)\n",
    "print(f\"ğŸ“¦ Model Configuration:\")\n",
    "print(f\"   Deployment Name: {model_deployment_name}\")\n",
    "print(f\"   Model Version: {model_version}\")\n",
    "print(f\"   Capacity (TPM): {model_capacity}\")\n",
    "print(f\"   (from config.json - set in Lab 1 infrastructure deployment)\\n\")\n",
    "\n",
    "# 3. .env íŒŒì¼ ìƒì„±\n",
    "\"\"\"\n",
    "NOTE: AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED=true ë¥¼ ì¶”ê°€í•˜ì—¬\n",
    "Tracing UIì—ì„œ Input/Output(í”„ë¡¬í”„íŠ¸, completion) ê¸°ë¡ì„ í™œì„±í™”í•©ë‹ˆë‹¤.\n",
    "AGENT_MASKING_MODE ëŠ” í”„ë¡¬í”„íŠ¸/ì‘ë‹µ ë§ˆìŠ¤í‚¹ ê°•ë„ë¥¼ ì œì–´í•©ë‹ˆë‹¤ (off|standard|strict).\n",
    "\"\"\"\n",
    "env_content = f\"\"\"# Azure AI Foundry Configuration\n",
    "PROJECT_CONNECTION_STRING={simple_project_conn}\n",
    "\n",
    "# Model Configuration\n",
    "# The model deployment name and version from Azure OpenAI\n",
    "# These values are automatically set from Lab 1 infrastructure deployment (infra/main.bicep)\n",
    "AZURE_AI_MODEL_DEPLOYMENT_NAME={model_deployment_name}\n",
    "AZURE_AI_MODEL_VERSION={model_version}\n",
    "\n",
    "# Azure AI Search Configuration\n",
    "SEARCH_ENDPOINT={SEARCH_ENDPOINT}\n",
    "SEARCH_KEY={SEARCH_KEY}\n",
    "SEARCH_INDEX={SEARCH_INDEX}\n",
    "\n",
    "# MCP Server Configuration\n",
    "MCP_ENDPOINT={MCP_ENDPOINT if MCP_ENDPOINT else ''}\n",
    "\n",
    "# Application Insights Configuration (for Application Analytics)\n",
    "APPLICATIONINSIGHTS_CONNECTION_STRING={APP_INSIGHTS_CONN_STR}\n",
    "\n",
    "# OpenTelemetry Configuration (for Tracing)\n",
    "OTEL_SERVICE_NAME=azure-ai-agent\n",
    "OTEL_TRACES_EXPORTER=azure_monitor\n",
    "OTEL_METRICS_EXPORTER=azure_monitor\n",
    "OTEL_LOGS_EXPORTER=azure_monitor\n",
    "OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true\n",
    "AZURE_TRACING_GEN_AI_CONTENT_RECORDING_ENABLED=true  # Enable GenAI content capture for tracing UI\n",
    "\n",
    "# Masking / PII Handling\n",
    "AGENT_MASKING_MODE=standard  # off|standard|strict (span prompt/completion masking mode)\n",
    "\"\"\"\n",
    "\n",
    "env_file_path = \"src/foundry_agent/.env\"\n",
    "\n",
    "try:\n",
    "    with open(env_file_path, 'w') as f:\n",
    "        f.write(env_content)\n",
    "    \n",
    "    print(f\"âœ… Created {env_file_path}\")\n",
    "    print(\"\\nğŸ“‹ Environment variables:\")\n",
    "    for line in env_content.strip().split('\\n'):\n",
    "        if line and not line.startswith('#'):\n",
    "            key = line.split('=')[0]\n",
    "            print(f\"   â€¢ {key}\")\n",
    "    \n",
    "    print(\"\\nğŸ’¡ ì´ íŒŒì¼ì€ Docker ì´ë¯¸ì§€ì— í¬í•¨ë©ë‹ˆë‹¤.\")\n",
    "    print(\"   ë°°í¬ ì‹œ ë³„ë„ì˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\")\n",
    "    \n",
    "    if APP_INSIGHTS_CONN_STR:\n",
    "        print(\"\\nâœ… Application Insights ì„¤ì • ì™„ë£Œ!\")\n",
    "        print(\"   â†’ Application Analyticsì—ì„œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\")\n",
    "        print(\"   â†’ OpenTelemetry Tracing ì„¤ì • ì™„ë£Œ!\")\n",
    "        print(\"   â†’ GenAI content recording í™œì„±í™” (Input/Output ê¸°ë¡ ì‹œë„)\")\n",
    "    else:\n",
    "        print(\"\\nâš ï¸  Application Insights ë¯¸ì„¤ì •\")\n",
    "        print(\"   â†’ Application AnalyticsëŠ” ì‘ë™í•˜ì§€ ì•Šì§€ë§Œ AgentëŠ” ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.\")\n",
    "    \n",
    "    print(\"\\nğŸ” Masking Mode: standard (AGENT_MASKING_MODE ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥)\")\n",
    "    print(f\"ğŸ¤– Model: {model_deployment_name} (version {model_version}, capacity {model_capacity}K TPM)\")\n",
    "except Exception as e:\n",
    "    print(f\"âŒ Failed to create .env file: {e}\")\n",
    "\n",
    "print(\"\\n\" + \"=\"*60)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "5a391560",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Building Agent Service Image ===\n",
      "Image: crf5gn2xuprfeyy.azurecr.io/agent-service:latest\n",
      "\n",
      "ğŸ”¨ Building image (linux/amd64)...\n",
      "âœ… Build successful (1.5s)\n",
      "   Image contains: main_agent.py, tool_agent.py, research_agent.py\n",
      "\n",
      "ğŸ“¤ Pushing image to registry...\n",
      "âœ… Push successful\n",
      "==================================================\n"
     ]
    }
   ],
   "source": [
    "# Agent Container ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ\n",
    "import time\n",
    "\n",
    "agent_image = f\"{CONTAINER_REGISTRY}/agent-service:latest\"\n",
    "\n",
    "print(\"=== Building Agent Service Image ===\")\n",
    "print(f\"Image: {agent_image}\\n\")\n",
    "\n",
    "# ë¹Œë“œ (Azure Container Appsìš© linux/amd64 í”Œë«í¼)\n",
    "build_cmd = f\"docker build --platform linux/amd64 -t {agent_image} ./src/foundry_agent\"\n",
    "print(\"ğŸ”¨ Building image (linux/amd64)...\")\n",
    "start_time = time.time()\n",
    "\n",
    "result = subprocess.run(build_cmd, shell=True, capture_output=True, text=True)\n",
    "elapsed = time.time() - start_time\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(f\"âœ… Build successful ({elapsed:.1f}s)\")\n",
    "    print(f\"   Image contains: main_agent.py, tool_agent.py, research_agent.py\")\n",
    "else:\n",
    "    print(f\"âŒ Build failed: {result.stderr}\")\n",
    "    \n",
    "# í‘¸ì‹œ\n",
    "if result.returncode == 0:\n",
    "    print(\"\\nğŸ“¤ Pushing image to registry...\")\n",
    "    push_cmd = f\"docker push {agent_image}\"\n",
    "    result = subprocess.run(push_cmd, shell=True, capture_output=True, text=True)\n",
    "    \n",
    "    if result.returncode == 0:\n",
    "        print(f\"âœ… Push successful\")\n",
    "    else:\n",
    "        print(f\"âŒ Push failed: {result.stderr}\")\n",
    "\n",
    "print(\"=\"*50)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2ba682df",
   "metadata": {},
   "source": [
    "## 7. Azure ë¦¬ì†ŒìŠ¤ í™•ì¸ (Verify Azure Resources)\n",
    "\n",
    "Agent Service ë°°í¬ ì „ì— í•„ìš”í•œ Azure ë¦¬ì†ŒìŠ¤ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.\n",
    "\n",
    "**í™•ì¸ í•­ëª©:**\n",
    "- âœ… Azure AI Project ë¦¬ì†ŒìŠ¤ ID\n",
    "- âœ… AI Services (Cognitive Services) ë¦¬ì†ŒìŠ¤ ID\n",
    "\n",
    "ì´ ì •ë³´ëŠ” ë‹¤ìŒ ë°°í¬ ë‹¨ê³„ì—ì„œ Managed Identityì— ê¶Œí•œì„ ìë™ìœ¼ë¡œ ë¶€ì—¬í•  ë•Œ ì‚¬ìš©ë©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "bb49c923",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Verifying Azure Resources ===\n",
      "\n",
      "ğŸ“‹ Project Information:\n",
      "   Resource Group: rg-aiagent-4sfcl5\n",
      "   Project Name: proj-f5gn2xuprfeyy\n",
      "\n",
      "ğŸ” Finding AI Project resource...\n",
      "   âœ… AI Project Resource ID:\n",
      "   /subscriptions/8627ae60-01d3-4a2d-9c33-89dea54cd4b4/resourceGroups/rg-aiagent-4sfcl5/providers/Microsoft.CognitiveServices/accounts/aoai-f5gn2xuprfeyy/projects/proj-f5gn2xuprfeyy\n",
      "\n",
      "ğŸ” Finding AI Services (Cognitive Services) resource...\n",
      "   âœ… AI Services Resource ID:\n",
      "   /subscriptions/8627ae60-01d3-4a2d-9c33-89dea54cd4b4/resourceGroups/rg-aiagent-4sfcl5/providers/Microsoft.CognitiveServices/accounts/aoai-f5gn2xuprfeyy\n",
      "\n",
      "âœ… All required resources verified!\n",
      "\n",
      "ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì´ ë¦¬ì†ŒìŠ¤ë“¤ì— ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.\n",
      "============================================================\n"
     ]
    }
   ],
   "source": [
    "# Azure AI Project ë° AI Services ë¦¬ì†ŒìŠ¤ ID í™•ì¸\n",
    "print(\"=== Verifying Azure Resources ===\\n\")\n",
    "\n",
    "# 1. config.jsonì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ ë¡œë“œë¨)\n",
    "# config.jsonì˜ PROJECT_CONNECTION_STRINGì€ ì´ë¯¸ ê°„ë‹¨í•œ í˜•ì‹:\n",
    "# https://xxx.services.ai.azure.com/api/projects/yyy\n",
    "\n",
    "# URLì—ì„œ project_name ì¶”ì¶œ\n",
    "if '/api/projects/' in simple_project_conn:\n",
    "    project_name = simple_project_conn.split('/api/projects/')[-1].strip()\n",
    "else:\n",
    "    project_name = None\n",
    "\n",
    "print(f\"ğŸ“‹ Project Information:\")\n",
    "print(f\"   Resource Group: {RESOURCE_GROUP}\")\n",
    "print(f\"   Project Name: {project_name if project_name else 'Not found in connection string'}\\n\")\n",
    "\n",
    "# 2. AI Project ë¦¬ì†ŒìŠ¤ ID ê°€ì ¸ì˜¤ê¸°\n",
    "# Azure AI Foundry ProjectëŠ” Microsoft.CognitiveServices/accounts/projects íƒ€ì…\n",
    "print(\"ğŸ” Finding AI Project resource...\")\n",
    "if project_name:\n",
    "    # project_nameì„ í¬í•¨í•˜ëŠ” ë¦¬ì†ŒìŠ¤ ê²€ìƒ‰\n",
    "    ai_project_cmd = f\"\"\"\n",
    "    az resource list \\\n",
    "        --resource-group {RESOURCE_GROUP} \\\n",
    "        --query \"[?contains(name, '{project_name}') && type=='Microsoft.CognitiveServices/accounts/projects'].id\" -o tsv\n",
    "    \"\"\"\n",
    "else:\n",
    "    # íƒ€ì…ìœ¼ë¡œë§Œ ê²€ìƒ‰ (ì²« ë²ˆì§¸ ê²°ê³¼)\n",
    "    ai_project_cmd = f\"\"\"\n",
    "    az resource list \\\n",
    "        --resource-group {RESOURCE_GROUP} \\\n",
    "        --query \"[?type=='Microsoft.CognitiveServices/accounts/projects'].id | [0]\" -o tsv\n",
    "    \"\"\"\n",
    "\n",
    "result = subprocess.run(ai_project_cmd, shell=True, capture_output=True, text=True)\n",
    "if result.returncode == 0 and result.stdout.strip():\n",
    "    ai_project_resource_id = result.stdout.strip()\n",
    "    print(f\"   âœ… AI Project Resource ID:\")\n",
    "    print(f\"   {ai_project_resource_id}\\n\")\n",
    "else:\n",
    "    print(f\"   âŒ Could not find AI Project\")\n",
    "    print(f\"   Error: {result.stderr}\\n\")\n",
    "    raise Exception(\"AI Project not found\")\n",
    "\n",
    "# 3. AI Services ë¦¬ì†ŒìŠ¤ ID ê°€ì ¸ì˜¤ê¸° (Cognitive Services account)\n",
    "print(\"ğŸ” Finding AI Services (Cognitive Services) resource...\")\n",
    "ai_services_cmd = f\"\"\"\n",
    "az resource list \\\n",
    "    --resource-group {RESOURCE_GROUP} \\\n",
    "    --resource-type Microsoft.CognitiveServices/accounts \\\n",
    "    --query \"[0].id\" -o tsv\n",
    "\"\"\"\n",
    "\n",
    "result = subprocess.run(ai_services_cmd, shell=True, capture_output=True, text=True)\n",
    "if result.returncode == 0 and result.stdout.strip():\n",
    "    ai_services_resource_id = result.stdout.strip()\n",
    "    print(f\"   âœ… AI Services Resource ID:\")\n",
    "    print(f\"   {ai_services_resource_id}\\n\")\n",
    "else:\n",
    "    print(f\"   âŒ Could not find AI Services\")\n",
    "    print(f\"   Error: {result.stderr}\\n\")\n",
    "    raise Exception(\"AI Services not found\")\n",
    "\n",
    "print(\"âœ… All required resources verified!\")\n",
    "print(\"\\nğŸ’¡ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì´ ë¦¬ì†ŒìŠ¤ë“¤ì— ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.\")\n",
    "print(\"=\"*60)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4319f207",
   "metadata": {},
   "source": [
    "## 8. Agent Service ë°°í¬ ë° ê¶Œí•œ ì„¤ì • (Deploy Agent Service with Permissions)\n",
    "\n",
    "Agent Serviceë¥¼ ë°°í¬í•˜ê³  **ë°°í¬ ì§í›„ ìë™ìœ¼ë¡œ** Managed Identityë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.\n",
    "\n",
    "### ìë™ ìˆ˜í–‰ ì‘ì—…\n",
    "\n",
    "1. âœ… Container App ë°°í¬\n",
    "2. âœ… System-assigned Managed Identity í™œì„±í™”\n",
    "3. âœ… Azure AI User ì—­í•  í• ë‹¹ (AI Project scope) â† agents/write ê¶Œí•œ\n",
    "4. âœ… ê¶Œí•œ ì „íŒŒ ëŒ€ê¸° ë° Container ì¬ì‹œì‘\n",
    "\n",
    "> ğŸ’¡ **ì¤‘ìš”**: ë°°í¬ì™€ ê¶Œí•œ ì„¤ì •ì„ í•œ ë²ˆì— ì²˜ë¦¬í•˜ë¯€ë¡œ ì™„ë£Œê¹Œì§€ ì•½ 3-4ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.\n",
    "> \n",
    "> âš ï¸ **ì°¸ê³ **: Managed IdentityëŠ” Container Appì´ ìƒì„±ëœ í›„ì—ë§Œ í™œì„±í™”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë°°í¬ ì§í›„ ì¦‰ì‹œ ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "36d8b217",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Deploying Agent Service to ACA ===\n",
      "App Name: agent-service\n",
      "\n",
      "ğŸ’¡ í™˜ê²½ ë³€ìˆ˜ëŠ” ì´ë¯¸ Docker ì´ë¯¸ì§€ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n",
      "   ë³„ë„ì˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n",
      "\n",
      "ğŸš€ Deploying Agent Service with Managed Identity...\n",
      "   (Starting with 0 replicas to configure permissions first)\n",
      "âœ… Deployment successful\n",
      "\n",
      "ğŸŒ Agent Endpoint: https://agent-service.gentletree-a093330c.eastus.azurecontainerapps.io\n",
      "âœ… Config updated\n",
      "\n",
      "============================================================\n",
      "ğŸ” Configuring Permissions\n",
      "\n",
      "1ï¸âƒ£ Getting Managed Identity Principal ID...\n",
      "   âœ… Principal ID: 187d539c-ca2c-4f87-852a-0308a8184eaa\n",
      "\n",
      "4ï¸âƒ£ Assigning 'Azure AI User' role to AI Project...\n",
      "   Scope: /subscriptions/8627ae60-01d3-4a2d-9c33-89dea54cd4b4/resourceGroups/rg-aiagent-4sfcl5/providers/Microsoft.CognitiveServices/accounts/aoai-f5gn2xuprfeyy/projects/proj-f5gn2xuprfeyy\n",
      "   âœ… Azure AI User role assigned (AI Project scope)\n",
      "\n",
      "5ï¸âƒ£ Verifying role assignments...\n",
      "\n",
      "   ğŸ“‹ Current Role Assignments (0 total):\n",
      "\n",
      "\n",
      "   ğŸ” Required Roles Verification:\n",
      "      âŒ Azure AI User (AI Project)\n",
      "\n",
      "   âŒ Some required roles are missing!\n",
      "      ì´ ë¬¸ì œê°€ ë°œìƒí•˜ë©´ Azure Portalì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.\n",
      "\n",
      "============================================================\n",
      "6ï¸âƒ£ Permissions assigned - waiting for propagation...\n",
      "\n",
      "âš ï¸  Azure RBAC ê¶Œí•œ ì „íŒŒëŠ” ìµœëŒ€ 5-10ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n",
      "   ContainerëŠ” replicas=0 ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.\n",
      "\n",
      "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:\n",
      "   1. ìœ„ì˜ 'Required Roles Verification'ì´ ëª¨ë‘ âœ…ì¸ì§€ í™•ì¸\n",
      "   2. 2-3ë¶„ ì •ë„ ê¸°ë‹¤ë¦¬ì„¸ìš”\n",
      "   3. ì•„ë˜ ì…€(ì„¹ì…˜ 5.2.1)ì„ ì‹¤í–‰í•˜ì—¬ Containerë¥¼ ì‹œì‘í•˜ì„¸ìš”\n",
      "   4. ë§Œì•½ ì—¬ì „íˆ ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´:\n",
      "      â†’ ì¶”ê°€ë¡œ 2-3ë¶„ ë” ê¸°ë‹¤ë¦° í›„ ì„¹ì…˜ 5.2.1ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”\n",
      "\n",
      "ğŸ’¡ Principal ID (ê¶Œí•œ í™•ì¸ìš©): 187d539c-ca2c-4f87-852a-0308a8184eaa\n",
      "\n",
      "============================================================\n",
      "âœ… Permissions configured successfully!\n",
      "\n",
      "ğŸŒ Endpoint: https://agent-service.gentletree-a093330c.eastus.azurecontainerapps.io\n",
      "\n",
      "ğŸ“‹ Assigned Roles:\n",
      "   â€¢ Azure AI User (AI Project scope) â† agents/write ê¶Œí•œ\n",
      "\n",
      "â³ ê¶Œí•œ ì „íŒŒë¥¼ ê¸°ë‹¤ë¦° í›„ ë‹¤ìŒ ì…€(5.2.1)ì„ ì‹¤í–‰í•˜ì„¸ìš”!\n",
      "\n",
      "============================================================\n"
     ]
    }
   ],
   "source": [
    "# Agent Serviceë¥¼ Container Appìœ¼ë¡œ ë°°í¬ + Managed Identity ê¶Œí•œ ì„¤ì •\n",
    "agent_app_name = \"agent-service\"\n",
    "\n",
    "print(\"=== Deploying Agent Service to ACA ===\")\n",
    "print(f\"App Name: {agent_app_name}\\n\")\n",
    "\n",
    "print(\"ğŸ’¡ í™˜ê²½ ë³€ìˆ˜ëŠ” ì´ë¯¸ Docker ì´ë¯¸ì§€ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\")\n",
    "print(\"   ë³„ë„ì˜ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •ì´ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\\n\")\n",
    "\n",
    "# 1. Container App ë°°í¬ (Managed Identity í¬í•¨, ê¶Œí•œ ë¶€ì—¬ ì „ê¹Œì§€ replicas 0)\n",
    "deploy_cmd = f\"\"\"\n",
    "az containerapp create \\\n",
    "    --name {agent_app_name} \\\n",
    "    --resource-group {RESOURCE_GROUP} \\\n",
    "    --environment {CONTAINER_ENV_ID.split('/')[-1]} \\\n",
    "    --image {agent_image} \\\n",
    "    --target-port 8000 \\\n",
    "    --ingress external \\\n",
    "    --min-replicas 0 \\\n",
    "    --max-replicas 3 \\\n",
    "    --cpu 1.0 \\\n",
    "    --memory 2.0Gi \\\n",
    "    --registry-server {CONTAINER_REGISTRY} \\\n",
    "    --system-assigned \\\n",
    "\"\"\"\n",
    "\n",
    "print(\"ğŸš€ Deploying Agent Service with Managed Identity...\")\n",
    "print(\"   (Starting with 0 replicas to configure permissions first)\")\n",
    "result = subprocess.run(deploy_cmd, shell=True, capture_output=True, text=True, timeout=180)\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(\"âœ… Deployment successful\\n\")\n",
    "    \n",
    "    # Get endpoint\n",
    "    show_cmd = f\"\"\"\n",
    "    az containerapp show \\\n",
    "        --name {agent_app_name} \\\n",
    "        --resource-group {RESOURCE_GROUP} \\\n",
    "        --query properties.configuration.ingress.fqdn -o tsv\n",
    "    \"\"\"\n",
    "    result = subprocess.run(show_cmd, shell=True, capture_output=True, text=True)\n",
    "    AGENT_ENDPOINT = f\"https://{result.stdout.strip()}\"\n",
    "    \n",
    "    print(f\"ğŸŒ Agent Endpoint: {AGENT_ENDPOINT}\")\n",
    "    \n",
    "    # Update config\n",
    "    config['agent_endpoint'] = AGENT_ENDPOINT\n",
    "    with open(config_path, 'w') as f:\n",
    "        json.dump(config, f, indent=2)\n",
    "    print(\"âœ… Config updated\\n\")\n",
    "    \n",
    "    # 2. Managed Identity Principal ID ê°€ì ¸ì˜¤ê¸°\n",
    "    print(\"=\"*60)\n",
    "    print(\"ğŸ” Configuring Permissions\\n\")\n",
    "    \n",
    "    print(\"1ï¸âƒ£ Getting Managed Identity Principal ID...\")\n",
    "    identity_cmd = f\"\"\"\n",
    "    az containerapp show \\\n",
    "        --name {agent_app_name} \\\n",
    "        --resource-group {RESOURCE_GROUP} \\\n",
    "        --query identity.principalId -o tsv\n",
    "    \"\"\"\n",
    "    \n",
    "    result = subprocess.run(identity_cmd, shell=True, capture_output=True, text=True)\n",
    "    if result.returncode == 0 and result.stdout.strip():\n",
    "        principal_id = result.stdout.strip()\n",
    "        print(f\"   âœ… Principal ID: {principal_id}\\n\")\n",
    "    else:\n",
    "        print(f\"   âŒ Failed to get Principal ID: {result.stderr}\\n\")\n",
    "        raise Exception(\"Failed to get Managed Identity Principal ID\")\n",
    "    \n",
    "    # 3. Azure AI User ì—­í•  í• ë‹¹ (AI Project scope - agents/write ê¶Œí•œìš©)\n",
    "    print(\"4ï¸âƒ£ Assigning 'Azure AI User' role to AI Project...\")\n",
    "    print(f\"   Scope: {ai_project_resource_id}\")\n",
    "    role_assignment_cmd = f\"\"\"\n",
    "    az role assignment create \\\n",
    "        --assignee {principal_id} \\\n",
    "        --role \"Azure AI User\" \\\n",
    "        --scope {ai_project_resource_id}\n",
    "    \"\"\"\n",
    "    \n",
    "    result = subprocess.run(role_assignment_cmd, shell=True, capture_output=True, text=True)\n",
    "    if result.returncode == 0:\n",
    "        print(\"   âœ… Azure AI User role assigned (AI Project scope)\\n\")\n",
    "    elif \"already exists\" in result.stderr.lower():\n",
    "        print(\"   âœ… Azure AI User role already exists (AI Project scope)\\n\")\n",
    "    else:\n",
    "        print(f\"   âŒ Role assignment FAILED!\")\n",
    "        print(f\"   Error: {result.stderr}\")\n",
    "        print(f\"   Return code: {result.returncode}\\n\")\n",
    "    \n",
    "    # 4. ê¶Œí•œ í• ë‹¹ ê²€ì¦\n",
    "    print(\"5ï¸âƒ£ Verifying role assignments...\\n\")\n",
    "    import time\n",
    "    time.sleep(5)  # ì ê¹ ëŒ€ê¸° (ì—­í•  í• ë‹¹ API ì™„ë£Œ í™•ì¸)\n",
    "    \n",
    "    role_check_cmd = f\"\"\"\n",
    "    az role assignment list \\\n",
    "        --assignee {principal_id} \\\n",
    "        --query \"[].{{role:roleDefinitionName, scope:scope}}\" -o json\n",
    "    \"\"\"\n",
    "    \n",
    "    result = subprocess.run(role_check_cmd, shell=True, capture_output=True, text=True)\n",
    "    if result.returncode == 0:\n",
    "        import json as json_lib\n",
    "        current_roles = json_lib.loads(result.stdout)\n",
    "        \n",
    "        print(f\"   ğŸ“‹ Current Role Assignments ({len(current_roles)} total):\\n\")\n",
    "        \n",
    "        # í•„ìš”í•œ ì—­í•  ì²´í¬\n",
    "        required_roles = {\n",
    "            \"Azure AI User (AI Project)\": False\n",
    "        }\n",
    "        \n",
    "        for role in current_roles:\n",
    "            scope_parts = role['scope'].split('/')\n",
    "            resource_name = scope_parts[-1] if scope_parts else 'Unknown'\n",
    "            role_name = role['role']\n",
    "            \n",
    "            print(f\"      â€¢ {role_name} â†’ {resource_name}\")\n",
    "            \n",
    "            if role_name == \"Azure AI User\":\n",
    "                if \"projects\" in role['scope'] or ai_project_resource_id in role['scope']:\n",
    "                    required_roles[\"Azure AI User (AI Project)\"] = True\n",
    "        \n",
    "        print(f\"\\n   ğŸ” Required Roles Verification:\")\n",
    "        all_roles_ok = True\n",
    "        for role_name, assigned in required_roles.items():\n",
    "            status = \"âœ…\" if assigned else \"âŒ\"\n",
    "            print(f\"      {status} {role_name}\")\n",
    "            if not assigned:\n",
    "                all_roles_ok = False\n",
    "        \n",
    "        if all_roles_ok:\n",
    "            print(f\"\\n   âœ… All required roles are assigned!\\n\")\n",
    "        else:\n",
    "            print(f\"\\n   âŒ Some required roles are missing!\")\n",
    "            print(f\"      ì´ ë¬¸ì œê°€ ë°œìƒí•˜ë©´ Azure Portalì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.\\n\")\n",
    "    else:\n",
    "        print(f\"   âš ï¸  Could not verify roles: {result.stderr}\\n\")\n",
    "    \n",
    "    # 5. ê¶Œí•œ ì „íŒŒ ëŒ€ê¸° ì•ˆë‚´\n",
    "    print(\"=\"*60)\n",
    "    print(\"6ï¸âƒ£ Permissions assigned - waiting for propagation...\\n\")\n",
    "    print(\"âš ï¸  Azure RBAC ê¶Œí•œ ì „íŒŒëŠ” ìµœëŒ€ 5-10ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\")\n",
    "    print(\"   ContainerëŠ” replicas=0 ìƒíƒœë¡œ ìœ ì§€ë©ë‹ˆë‹¤.\\n\")\n",
    "    \n",
    "    print(\"ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:\")\n",
    "    print(\"   1. ìœ„ì˜ 'Required Roles Verification'ì´ ëª¨ë‘ âœ…ì¸ì§€ í™•ì¸\")\n",
    "    print(\"   2. 2-3ë¶„ ì •ë„ ê¸°ë‹¤ë¦¬ì„¸ìš”\")\n",
    "    print(\"   3. ì•„ë˜ ì…€(ì„¹ì…˜ 5.2.1)ì„ ì‹¤í–‰í•˜ì—¬ Containerë¥¼ ì‹œì‘í•˜ì„¸ìš”\")\n",
    "    print(\"   4. ë§Œì•½ ì—¬ì „íˆ ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´:\")\n",
    "    print(\"      â†’ ì¶”ê°€ë¡œ 2-3ë¶„ ë” ê¸°ë‹¤ë¦° í›„ ì„¹ì…˜ 5.2.1ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”\\n\")\n",
    "    \n",
    "    print(f\"ğŸ’¡ Principal ID (ê¶Œí•œ í™•ì¸ìš©): {principal_id}\\n\")\n",
    "    \n",
    "    print(\"=\"*60)\n",
    "    print(\"âœ… Permissions configured successfully!\")\n",
    "    print(f\"\\nğŸŒ Endpoint: {AGENT_ENDPOINT}\")\n",
    "    print(f\"\\nğŸ“‹ Assigned Roles:\")\n",
    "    print(f\"   â€¢ Azure AI User (AI Project scope) â† agents/write ê¶Œí•œ\")\n",
    "    print(f\"\\nâ³ ê¶Œí•œ ì „íŒŒë¥¼ ê¸°ë‹¤ë¦° í›„ ë‹¤ìŒ ì…€(5.2.1)ì„ ì‹¤í–‰í•˜ì„¸ìš”!\")\n",
    "else:\n",
    "    print(f\"âŒ Deployment failed: {result.stderr}\")\n",
    "    AGENT_ENDPOINT = None\n",
    "print(\"\\n\" + \"=\"*60)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "455f3ae4",
   "metadata": {},
   "source": [
    "## 9. Agent Service ì‹œì‘ (Start Agent Service)\n",
    "\n",
    "ê¶Œí•œ ì „íŒŒê°€ ì™„ë£Œëœ í›„ ì´ ì…€ì„ ì‹¤í–‰í•˜ì—¬ Containerë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.\n",
    "\n",
    "**ì‹¤í–‰ ì‹œì :**\n",
    "- â° ì„¹ì…˜ 5.2 ì™„ë£Œ í›„ **2-3ë¶„ ëŒ€ê¸°**\n",
    "- âš ï¸ ê¶Œí•œ ì˜¤ë¥˜ ë°œìƒ ì‹œ: ì¶”ê°€ë¡œ 2-3ë¶„ ë” ê¸°ë‹¤ë¦° í›„ ì¬ì‹¤í–‰\n",
    "\n",
    "**ìˆ˜í–‰ ì‘ì—…:**\n",
    "- âœ… Container Appì„ replicas=1ë¡œ í™•ì¥\n",
    "- âœ… Container ì‹œì‘ ë° ìƒíƒœ í™•ì¸"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "82fa93d2",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸš€ Scaling to 1 replica...\n",
      "âœ… Agent Service started successfully!\n",
      "\n",
      "ğŸŒ Endpoint: https://agent-service.gentletree-a093330c.eastus.azurecontainerapps.io\n",
      "\n",
      "ğŸ’¡ Containerê°€ ì‹œì‘ë˜ëŠ” ë° ì•½ 30ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.\n",
      "   ë¡œê·¸ í™•ì¸: az containerapp logs show --name agent-service --resource-group rg-aiagent-4sfcl5 --tail 50\n",
      "\n",
      "============================================================\n"
     ]
    }
   ],
   "source": [
    "# replicasë¥¼ 1ë¡œ í™•ì¥\n",
    "scale_cmd = f\"\"\"\n",
    "az containerapp update \\\n",
    "    --name agent-service \\\n",
    "    --resource-group {RESOURCE_GROUP} \\\n",
    "    --min-replicas 1 \\\n",
    "    --max-replicas 1\n",
    "\"\"\"\n",
    "\n",
    "print(\"ğŸš€ Scaling to 1 replica...\")\n",
    "result = subprocess.run(scale_cmd, shell=True, capture_output=True, text=True, timeout=120)\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(\"âœ… Agent Service started successfully!\")\n",
    "    print(f\"\\nğŸŒ Endpoint: {AGENT_ENDPOINT}\")\n",
    "    print(\"\\nğŸ’¡ Containerê°€ ì‹œì‘ë˜ëŠ” ë° ì•½ 30ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.\")\n",
    "    print(f\"   ë¡œê·¸ í™•ì¸: az containerapp logs show --name agent-service --resource-group {RESOURCE_GROUP} --tail 50\")\n",
    "else:\n",
    "    print(f\"âŒ Failed to start: {result.stderr}\")\n",
    "\n",
    "print(\"\\n\" + \"=\"*60)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "05cc46f0",
   "metadata": {},
   "source": [
    "## 10. ğŸš€ ë°°í¬ëœ Agent í…ŒìŠ¤íŠ¸ (Test Deployed Agent via HTTP)\n",
    "\n",
    "**ì¤‘ìš”í•œ ì°¨ì´ì :**\n",
    "\n",
    "ì´ì „ ì„¹ì…˜ 6, 7ì—ì„œëŠ” **ë…¸íŠ¸ë¶ì—ì„œ ë¡œì»¬ë¡œ Agentë¥¼ ìƒì„±**í•˜ì—¬ í…ŒìŠ¤íŠ¸í–ˆìŠµë‹ˆë‹¤.\n",
    "- âŒ ë¡œì»¬ í…ŒìŠ¤íŠ¸ â†’ Application Analyticsì— **ë°ì´í„°ê°€ ë‚˜íƒ€ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤**\n",
    "\n",
    "ì´ ì„¹ì…˜ì—ì„œëŠ” **ë°°í¬ëœ Containerì˜ HTTP API**ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.\n",
    "- âœ… Container í…ŒìŠ¤íŠ¸ â†’ Application Analyticsì— **ë°ì´í„°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤**\n",
    "- âœ… Container í…ŒìŠ¤íŠ¸ â†’ **Tracing**ë„ í™œì„±í™”ë©ë‹ˆë‹¤ (ìƒì„¸ ì‹¤í–‰ ë¡œê·¸)\n",
    "\n",
    "**ì™œ ì°¨ì´ê°€ ë‚ ê¹Œìš”?**\n",
    "- Application AnalyticsëŠ” **Azure AI Foundry Projectì—ì„œ ì‹¤í–‰ëœ Agent**ë§Œ ì¶”ì í•©ë‹ˆë‹¤\n",
    "- ë…¸íŠ¸ë¶ì€ ë¡œì»¬ í™˜ê²½ì´ë¯€ë¡œ ë³„ë„ë¡œ ì¶”ì ë©ë‹ˆë‹¤\n",
    "- Container ë‚´ë¶€ì˜ AgentëŠ” Projectì— ì—°ê²°ë˜ì–´ ìˆì–´ ìë™ìœ¼ë¡œ ì¶”ì ë©ë‹ˆë‹¤\n",
    "\n",
    "**í…ŒìŠ¤íŠ¸ ë°©ë²•:**\n",
    "1. ë°°í¬ëœ Agent Serviceì˜ `/chat` ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ\n",
    "2. ë‹¤ì–‘í•œ ì§ˆë¬¸ìœ¼ë¡œ Agent í…ŒìŠ¤íŠ¸\n",
    "3. 5-10ë¶„ í›„ Application Analytics í™•ì¸\n",
    "4. **Tracing íƒ­**ì—ì„œ ìƒì„¸ ì‹¤í–‰ íë¦„ í™•ì¸ (LLM ìš”ì²­, Tool í˜¸ì¶œ ë“±)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "f9a9f49d",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== ë°°í¬ëœ Agent Service í…ŒìŠ¤íŠ¸ ===\n",
      "\n",
      "ğŸŒ Agent Endpoint: https://agent-service.gentletree-a093330c.eastus.azurecontainerapps.io\n",
      "\n",
      "1ï¸âƒ£ Health Check:\n",
      "   âœ… Health: {'status': 'healthy', 'service': 'Agent API Server'}\n",
      "\n",
      "2ï¸âƒ£ Agent Status:\n",
      "   âœ… Status: running\n",
      "   ğŸ“‹ Agents:\n",
      "      âœ… main_agent: True\n",
      "      âœ… tool_agent: True\n",
      "      âœ… research_agent: True\n",
      "\n",
      "======================================================================\n",
      "\n",
      "ğŸ’¡ Agent Serviceê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!\n",
      "   ë‹¤ìŒ ì…€ì—ì„œ ì‹¤ì œ ì§ˆë¬¸ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.\n",
      "\n",
      "======================================================================\n"
     ]
    }
   ],
   "source": [
    "import requests\n",
    "import json\n",
    "\n",
    "print(\"=== ë°°í¬ëœ Agent Service í…ŒìŠ¤íŠ¸ ===\\n\")\n",
    "\n",
    "# Agent ì—”ë“œí¬ì¸íŠ¸ í™•ì¸\n",
    "if not AGENT_ENDPOINT:\n",
    "    print(\"âŒ AGENT_ENDPOINTê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!\")\n",
    "    print(\"   ì„¹ì…˜ 5.2ë¥¼ ë¨¼ì € ì‹¤í–‰í•˜ì„¸ìš”.\\n\")\n",
    "else:\n",
    "    print(f\"ğŸŒ Agent Endpoint: {AGENT_ENDPOINT}\\n\")\n",
    "    \n",
    "    # 1. Health check\n",
    "    print(\"1ï¸âƒ£ Health Check:\")\n",
    "    try:\n",
    "        response = requests.get(f\"{AGENT_ENDPOINT}/health\", timeout=10)\n",
    "        if response.status_code == 200:\n",
    "            print(f\"   âœ… Health: {response.json()}\\n\")\n",
    "        else:\n",
    "            print(f\"   âŒ Health check failed: {response.status_code}\\n\")\n",
    "    except Exception as e:\n",
    "        print(f\"   âŒ Error: {e}\\n\")\n",
    "    \n",
    "    # 2. Root endpoint í™•ì¸ (Agent ìƒíƒœ)\n",
    "    print(\"2ï¸âƒ£ Agent Status:\")\n",
    "    try:\n",
    "        response = requests.get(f\"{AGENT_ENDPOINT}/\", timeout=10)\n",
    "        if response.status_code == 200:\n",
    "            status = response.json()\n",
    "            print(f\"   âœ… Status: {status.get('status')}\")\n",
    "            print(f\"   ğŸ“‹ Agents:\")\n",
    "            for agent_name, available in status.get('agents', {}).items():\n",
    "                icon = \"âœ…\" if available else \"âŒ\"\n",
    "                print(f\"      {icon} {agent_name}: {available}\")\n",
    "            print()\n",
    "        else:\n",
    "            print(f\"   âŒ Status check failed: {response.status_code}\\n\")\n",
    "    except Exception as e:\n",
    "        print(f\"   âŒ Error: {e}\\n\")\n",
    "    \n",
    "    print(\"=\"*70)\n",
    "    print(\"\\nğŸ’¡ Agent Serviceê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!\")\n",
    "    print(\"   ë‹¤ìŒ ì…€ì—ì„œ ì‹¤ì œ ì§ˆë¬¸ì„ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.\\n\")\n",
    "    print(\"=\"*70)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7d087e2a",
   "metadata": {},
   "source": [
    "## 11. Main Agent í…ŒìŠ¤íŠ¸ (ë‹¤ì–‘í•œ ì§ˆë¬¸)\n",
    "\n",
    "ë°°í¬ëœ Main Agentì— ë‹¤ì–‘í•œ ì§ˆë¬¸ì„ ë³´ë‚´ì„œ Application Analytics ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.\n",
    "\n",
    "### ğŸ“š Research Agentì˜ Citation ê¸°ëŠ¥\n",
    "\n",
    "Research Agentê°€ Azure AI Searchë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹µë³€í•  ë•Œ, **ìë™ìœ¼ë¡œ ì¶œì²˜(citation)**ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤:\n",
    "\n",
    "**Citation í˜•ì‹:**\n",
    "- `ã€3:0â€ sourceã€‘` = 3ë²ˆ ë©”ì‹œì§€ì˜ 0ë²ˆì§¸ annotation\n",
    "- `ã€3:1â€ sourceã€‘` = 3ë²ˆ ë©”ì‹œì§€ì˜ 1ë²ˆì§¸ annotation\n",
    "- `ã€4:0â€ sourceã€‘` = 4ë²ˆ ë©”ì‹œì§€ì˜ 0ë²ˆì§¸ annotation\n",
    "\n",
    "**ì˜ˆì‹œ ì‘ë‹µ:**\n",
    "```\n",
    "ì œì£¼ë„ ìš°ë„ëŠ” ì•„ë¦„ë‹¤ìš´ ìì—° ê²½ê´€ì„ ìë‘í•˜ëŠ” ì„¬ì…ë‹ˆë‹¤ã€3:0â€ sourceã€‘.\n",
    "ì„±ì‚°ì¼ì¶œë´‰ì€ ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ìì—°ìœ ì‚°ìœ¼ë¡œ ë“±ì¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤ã€3:1â€ sourceã€‘.\n",
    "```\n",
    "\n",
    "**ì‘ë™ ì›ë¦¬:**\n",
    "1. `AzureAISearchTool`ì´ ì§€ì‹ ë² ì´ìŠ¤ ê²€ìƒ‰\n",
    "2. ê²€ìƒ‰ëœ ë¬¸ì„œê°€ Agent contextì— ìë™ ì£¼ì…\n",
    "3. LLMì´ ë‹µë³€ ìƒì„± ì‹œ ë¬¸ì„œ ì°¸ì¡°\n",
    "4. Azure AI Foundry SDKê°€ ìë™ìœ¼ë¡œ citation ì¶”ê°€\n",
    "5. Tracing UIì—ì„œ ê° citation í´ë¦­ ì‹œ ì›ë³¸ ë¬¸ì„œ í™•ì¸ ê°€ëŠ¥\n",
    "\n",
    "> ğŸ’¡ **ì°¸ê³ :** Citationì€ Azure AI Foundry Agent Serviceì˜ ë‚´ì¥ ê¸°ëŠ¥ìœ¼ë¡œ, ì½”ë“œì—ì„œ ë³„ë„ë¡œ êµ¬í˜„í•˜ì§€ ì•Šì•„ë„ ìë™ ìƒì„±ë©ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "63760639",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== ë°°í¬ëœ Main Agent í…ŒìŠ¤íŠ¸ ===\n",
      "\n",
      "======================================================================\n",
      "[Test 1/3]\n",
      "ì§ˆë¬¸: ì•ˆë…•í•˜ì„¸ìš”.\n",
      "ì„¤ëª…: ì¼ë°˜ ëŒ€í™”\n",
      "======================================================================\n",
      "\n",
      "âœ… ì‘ë‹µ ì„±ê³µ (HTTP 200) - 3923.7 ms\n",
      "\n",
      "ğŸ“ Agent ì‘ë‹µ (ì „ì²´ í‘œì‹œ):\n",
      "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ì—¬í–‰ì§€ ì¶”ì²œ, ë‚ ì”¨ ì •ë³´, í˜¹ì€ ë‹¤ë¥¸ ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ˜Š\n",
      "\n",
      "======================================================================\n",
      "[Test 2/3]\n",
      "ì§ˆë¬¸: ì„œìš¸ì˜ í˜„ì¬ ë‚ ì”¨ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ì˜¨ë„ì™€ ì²´ê°ì˜¨ë„, ë‚ ì”¨ ìƒíƒœ, ìŠµë„, ë°”ëŒ ì •ë³´ë¥¼ ëª¨ë‘ í¬í•¨í•´ì£¼ì„¸ìš”.\n",
      "ì„¤ëª…: ì„œìš¸ ìƒì„¸ ë‚ ì”¨ ì •ë³´ (Tool Agent ì‚¬ìš©)\n",
      "======================================================================\n",
      "\n",
      "âœ… ì‘ë‹µ ì„±ê³µ (HTTP 200) - 8292.4 ms\n",
      "\n",
      "ğŸ“ Agent ì‘ë‹µ (ì „ì²´ í‘œì‹œ):\n",
      "í˜„ì¬ ì„œìš¸ì˜ ë‚ ì”¨ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n",
      "\n",
      "- **ì˜¨ë„:** 18Â°C  \n",
      "- **ì²´ê° ì˜¨ë„:** 17Â°C  \n",
      "- **ë‚ ì”¨ ìƒíƒœ:** ë§‘ìŒ  \n",
      "- **ìŠµë„:** 45%  \n",
      "- **ë°”ëŒ:** ë¶ì„œìª½ìœ¼ë¡œ ì‹œì† 12km  \n",
      "\n",
      "ì¶”ê°€ì ìœ¼ë¡œ ê¶ê¸ˆí•œ ì‚¬í•­ì´ ìˆìœ¼ë©´ ì•Œë ¤ì£¼ì„¸ìš”!\n",
      "\n",
      "======================================================================\n",
      "[Test 3/3]\n",
      "ì§ˆë¬¸: ì œì£¼ë„ ì—¬í–‰ ì¶”ì²œ ëª…ì†Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”\n",
      "ì„¤ëª…: ì—¬í–‰ì§€ ì¶”ì²œ (Research Agent ì‚¬ìš©)\n",
      "======================================================================\n",
      "\n",
      "âœ… ì‘ë‹µ ì„±ê³µ (HTTP 200) - 13150.0 ms\n",
      "\n",
      "ğŸ“ Agent ì‘ë‹µ (ì „ì²´ í‘œì‹œ):\n",
      "ì œì£¼ë„ëŠ” ì•„ë¦„ë‹¤ìš´ ìì—°ê²½ê´€, ë…íŠ¹í•œ ë¬¸í™”, ê·¸ë¦¬ê³  ë‹¤ì–‘í•œ í™œë™ì´ ê°€ëŠ¥í•œ ìµœê³ ì˜ ì—¬í–‰ì§€ì…ë‹ˆë‹¤. ë‹¤ìŒì€ ì¶”ì²œ ëª…ì†Œë“¤ì…ë‹ˆë‹¤:\n",
      "\n",
      "---\n",
      "\n",
      "### 1. **ì„±ì‚°ì¼ì¶œë´‰**\n",
      "- **íŠ¹ì§•**: ìœ ë„¤ìŠ¤ì½” ì„¸ê³„ìì—°ìœ ì‚°ìœ¼ë¡œ ì§€ì •ëœ í™”ì‚° ë¶„í™”êµ¬ë¡œ ìœ ëª…í•˜ë©°, ì •ìƒì—ì„œ ì¼ì¶œì„ ê°ìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n",
      "- **ì¶”ì²œ í™œë™**: ë¶„í™”êµ¬ ì‚°ì±…, 360ë„ íŒŒë…¸ë¼ë§ˆ ì „ë§ ê°ìƒ, ì œì£¼ í•´ë…€ë“¤ì˜ ë¬¼ì§ˆ ê³µì—° ê´€ëŒ.\n",
      "- **ì£¼ë³€ ëª…ì†Œ**: ì„­ì§€ì½”ì§€, ê´‘ì¹˜ê¸°í•´ë³€.\n",
      "\n",
      "---\n",
      "\n",
      "### 2. **í•¨ë• í•´ìˆ˜ìš•ì¥**\n",
      "- **íŠ¹ì§•**: ì—ë©”ë„ë“œë¹› ë°”ë‹¤ì™€ ì–•ì€ ìˆ˜ì‹¬ìœ¼ë¡œ ê°€ì¡± ë‹¨ìœ„ì˜ ì—¬í–‰ê°ì—ê²Œ ì´ìƒì ì¸ ì¥ì†Œì…ë‹ˆë‹¤.\n",
      "- **ì¶”ì²œ í™œë™**: í•´ë³€ ì‚°ì±…, ì„œìš°ë´‰ ë“±ë°˜, ê°ì„± ì¹´í˜ íƒë°©.\n",
      "- **ì£¼ë³€ ëª…ì†Œ**: ê¹€ë…•ë¯¸ë¡œê³µì›, ì›”ì •ë¦¬ í•´ë³€. ì§€ì—­ íŠ¹ì‚°ìŒì‹, ì„±ê²Œë¯¸ì—­êµ­ ë° ì „ë³µì£½ë„ ë§›ë³´ì„¸ìš”.\n",
      "\n",
      "---\n",
      "\n",
      "### 3. **ìš°ë„**\n",
      "- **íŠ¹ì§•**: ì†Œê°€ ëˆ„ì›ŒìˆëŠ” ëª¨ìŠµì²˜ëŸ¼ ë³´ì´ëŠ” ì„¬ìœ¼ë¡œ, êµ­ë‚´ ìœ ì¼ì˜ í™ì¡°ë‹¨ê´´ í•´ë³€ì¸ ì„œë¹ˆë°±ì‚¬ í•´ë³€ì´ ìœ ëª…í•©ë‹ˆë‹¤.\n",
      "- **ì¶”ì²œ í™œë™**: ìì „ê±°ì™€ ì „ê¸°ì°¨ë¡œ ì„¬ ë‘˜ëŸ¬ë³´ê¸°, ìš°ë„ë´‰ ì „ë§ëŒ€ ë°©ë¬¸, ë•…ì½© ì•„ì´ìŠ¤í¬ë¦¼ê³¼ ë§‰ê±¸ë¦¬ ë§›ë³´ê¸°.\n",
      "- **êµí†µ**: ì„±ì‚°í¬í•­ì—ì„œ ë°°í¸ìœ¼ë¡œ ì´ë™ ê°€ëŠ¥í•˜ë©° ì•½ 15ë¶„ ì†Œìš”ë©ë‹ˆë‹¤.\n",
      "\n",
      "---\n",
      "\n",
      "ì´ ì™¸ì—ë„ ì œì£¼ì—ëŠ” ë‹¤ì–‘í•œ ëª…ì†Œê°€ ë§ìœ¼ë‹ˆ ì—¬í–‰ ê³„íš ì‹œ ì°¸ê³ í•˜ì‹œì–´ ì œì£¼ë„ì˜ ë§¤ë ¥ì„ ë§ˆìŒê» ì¦ê²¨ë³´ì„¸ìš”!ã€3:0â€ sourceã€‘ã€3:1â€ sourceã€‘ã€3:2â€ sourceã€‘\n",
      "\n",
      "======================================================================\n",
      "\n",
      "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:\n",
      "   âœ… ì„±ê³µ: 3/3\n",
      "   âŒ ì‹¤íŒ¨: 0/3\n",
      "   â±ï¸  í‰ê·  ì§€ì—° (client ì¸¡ì •): 8455.4 ms (p95â‰ˆ8292.4 ms)\n",
      "   â„¹ï¸  Portalì˜ Average inference call duration ê³¼ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì„œë²„ ì¸¡ ì¶”ì ).\n",
      "\n",
      "ğŸ‰ 3ê°œì˜ Agent í˜¸ì¶œì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!\n",
      "\n",
      "ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:\n",
      "   1. 5-10ë¶„ ì •ë„ ê¸°ë‹¤ë¦¬ì„¸ìš” (ë°ì´í„° ì²˜ë¦¬ ì‹œê°„)\n",
      "   2. Azure AI Foundry í¬í„¸ ì ‘ì†: https://ai.azure.com\n",
      "   3. í”„ë¡œì íŠ¸ â†’ 'í‰ê°€' â†’ 'Application Analytics'\n",
      "   4. ì‹œê°„ ë²”ìœ„ë¥¼ 'ì§€ë‚œ 24ì‹œê°„'ìœ¼ë¡œ ì„¤ì •\n",
      "   5. ë©”íŠ¸ë¦­ í™•ì¸:\n",
      "      â€¢ Total inference calls: 3+ ê±´\n",
      "      â€¢ Average inference call duration: Portal ê°’ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ í‰ê·  8455.4 ms ì°¸ê³ )\n",
      "      â€¢ Error rate: 0/3\n",
      "\n",
      "   ğŸ“‹ ì°¸ê³ : ë” ë§ì€ ìš”ì²­ì„ ë³´ë‚¼ìˆ˜ë¡ ë°ì´í„°ê°€ ë” ë¹¨ë¦¬ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.\n",
      "           ì´ ì…€ì„ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•´ë„ ë©ë‹ˆë‹¤!\n",
      "\n",
      "======================================================================\n"
     ]
    }
   ],
   "source": [
    "# ë°°í¬ëœ Main Agentì— ë‹¤ì–‘í•œ ì§ˆë¬¸ ë³´ë‚´ê¸°\n",
    "import requests\n",
    "import json\n",
    "import time\n",
    "import statistics\n",
    "\n",
    "print(\"=== ë°°í¬ëœ Main Agent í…ŒìŠ¤íŠ¸ ===\\n\")\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ (3ê°œ)\n",
    "test_cases = [\n",
    "    {\n",
    "        \"message\": \"ì•ˆë…•í•˜ì„¸ìš”.\",\n",
    "        \"description\": \"ì¼ë°˜ ëŒ€í™”\"\n",
    "    },\n",
    "    {\n",
    "        \"message\": \"ì„œìš¸ì˜ í˜„ì¬ ë‚ ì”¨ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ì˜¨ë„ì™€ ì²´ê°ì˜¨ë„, ë‚ ì”¨ ìƒíƒœ, ìŠµë„, ë°”ëŒ ì •ë³´ë¥¼ ëª¨ë‘ í¬í•¨í•´ì£¼ì„¸ìš”.\",\n",
    "        \"description\": \"ì„œìš¸ ìƒì„¸ ë‚ ì”¨ ì •ë³´ (Tool Agent ì‚¬ìš©)\"\n",
    "    },\n",
    "    {\n",
    "        \"message\": \"ì œì£¼ë„ ì—¬í–‰ ì¶”ì²œ ëª…ì†Œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”\",\n",
    "        \"description\": \"ì—¬í–‰ì§€ ì¶”ì²œ (Research Agent ì‚¬ìš©)\"\n",
    "    }\n",
    "]\n",
    "\n",
    "# ì¶œë ¥ ì˜µì…˜\n",
    "TRUNCATE = False           # True ë¡œ í•˜ë©´ 300ì ë¯¸ë¦¬ë³´ê¸°\n",
    "PREVIEW_CHARS = 300\n",
    "\n",
    "success_count = 0\n",
    "fail_count = 0\n",
    "latencies = []\n",
    "\n",
    "for i, test in enumerate(test_cases, 1):\n",
    "    print(f\"{'='*70}\")\n",
    "    print(f\"[Test {i}/{len(test_cases)}]\")\n",
    "    print(f\"ì§ˆë¬¸: {test['message']}\")\n",
    "    print(f\"ì„¤ëª…: {test['description']}\")\n",
    "    print(f\"{'='*70}\")\n",
    "    \n",
    "    try:\n",
    "        start_req = time.perf_counter()\n",
    "        response = requests.post(\n",
    "            f\"{AGENT_ENDPOINT}/chat\",\n",
    "            json={\"message\": test['message']},\n",
    "            headers={\"Content-Type\": \"application/json\"},\n",
    "            timeout=90\n",
    "        )\n",
    "        elapsed_req = (time.perf_counter() - start_req) * 1000  # ms\n",
    "        \n",
    "        if response.status_code == 200:\n",
    "            result = response.json()\n",
    "            full_resp = result.get('response', 'No response') or ''\n",
    "            print(f\"\\nâœ… ì‘ë‹µ ì„±ê³µ (HTTP {response.status_code}) - {elapsed_req:.1f} ms\")\n",
    "            latencies.append(elapsed_req)\n",
    "            print(f\"\\nğŸ“ Agent ì‘ë‹µ (ì „ì²´ í‘œì‹œ):\" if not TRUNCATE else f\"\\nğŸ“ Agent ì‘ë‹µ (ì• {PREVIEW_CHARS}ì):\")\n",
    "            if TRUNCATE and len(full_resp) > PREVIEW_CHARS:\n",
    "                print(full_resp[:PREVIEW_CHARS] + '...')\n",
    "            else:\n",
    "                print(full_resp)\n",
    "            print()\n",
    "            success_count += 1\n",
    "        else:\n",
    "            print(f\"\\nâŒ ìš”ì²­ ì‹¤íŒ¨ (HTTP {response.status_code})\")\n",
    "            print(f\"ì˜¤ë¥˜: {response.text[:200]}\")\n",
    "            print()\n",
    "            fail_count += 1\n",
    "        \n",
    "    except Exception as e:\n",
    "        print(f\"\\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}\")\n",
    "        print()\n",
    "        fail_count += 1\n",
    "    \n",
    "    if i < len(test_cases):\n",
    "        time.sleep(2)\n",
    "\n",
    "print(\"=\"*70)\n",
    "print(f\"\\nğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:\")\n",
    "print(f\"   âœ… ì„±ê³µ: {success_count}/{len(test_cases)}\")\n",
    "print(f\"   âŒ ì‹¤íŒ¨: {fail_count}/{len(test_cases)}\")\n",
    "\n",
    "if success_count > 0:\n",
    "    avg_latency = statistics.mean(latencies) if latencies else 0\n",
    "    p95_latency = (sorted(latencies)[int(len(latencies)*0.95)-1] if len(latencies) >= 2 else latencies[0]) if latencies else 0\n",
    "    print(f\"   â±ï¸  í‰ê·  ì§€ì—° (client ì¸¡ì •): {avg_latency:.1f} ms (p95â‰ˆ{p95_latency:.1f} ms)\")\n",
    "    print(f\"   â„¹ï¸  Portalì˜ Average inference call duration ê³¼ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì„œë²„ ì¸¡ ì¶”ì ).\")\n",
    "    print(f\"\\nğŸ‰ {success_count}ê°œì˜ Agent í˜¸ì¶œì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!\")\n",
    "    print(f\"\\nğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:\")\n",
    "    print(f\"   1. 5-10ë¶„ ì •ë„ ê¸°ë‹¤ë¦¬ì„¸ìš” (ë°ì´í„° ì²˜ë¦¬ ì‹œê°„)\")\n",
    "    print(f\"   2. Azure AI Foundry í¬í„¸ ì ‘ì†: https://ai.azure.com\")\n",
    "    print(f\"   3. í”„ë¡œì íŠ¸ â†’ 'í‰ê°€' â†’ 'Application Analytics'\")\n",
    "    print(f\"   4. ì‹œê°„ ë²”ìœ„ë¥¼ 'ì§€ë‚œ 24ì‹œê°„'ìœ¼ë¡œ ì„¤ì •\")\n",
    "    print(f\"   5. ë©”íŠ¸ë¦­ í™•ì¸:\")\n",
    "    print(f\"      â€¢ Total inference calls: {success_count}+ ê±´\")\n",
    "    print(f\"      â€¢ Average inference call duration: Portal ê°’ (í´ë¼ì´ì–¸íŠ¸ ì¸¡ í‰ê·  {avg_latency:.1f} ms ì°¸ê³ )\")\n",
    "    print(f\"      â€¢ Error rate: {fail_count}/{len(test_cases)}\")\n",
    "    print(f\"\\n   ğŸ“‹ ì°¸ê³ : ë” ë§ì€ ìš”ì²­ì„ ë³´ë‚¼ìˆ˜ë¡ ë°ì´í„°ê°€ ë” ë¹¨ë¦¬ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.\")\n",
    "    print(f\"           ì´ ì…€ì„ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•´ë„ ë©ë‹ˆë‹¤!\")\n",
    "else:\n",
    "    print(f\"\\nâŒ ëª¨ë“  ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\")\n",
    "    print(f\"   Container ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”:\")\n",
    "    print(f\"   az containerapp logs show --name agent-service --resource-group {RESOURCE_GROUP} --tail 50\")\n",
    "\n",
    "print(\"\\n\" + \"=\"*70)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "75a6ce5b",
   "metadata": {},
   "source": [
    "## 12. ë°°í¬ ì™„ë£Œ ë° ìš”ì•½ (Deployment Summary)\n",
    "\n",
    "ì¶•í•˜í•©ë‹ˆë‹¤! Azure AI Foundry Agent Service ë°°í¬ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n",
    "\n",
    "### ë°°í¬ëœ ë¦¬ì†ŒìŠ¤ (Deployed Resources)\n",
    "\n",
    "| ë¦¬ì†ŒìŠ¤ íƒ€ì… | ìš©ë„ | ìƒíƒœ |\n",
    "|------------|------|------|\n",
    "| MCP Server (Container App) | Model Context Protocol ë„êµ¬ ì„œë²„ | âœ… ë°°í¬ë¨ |\n",
    "| Agent Service (Container App) | Multi-Agent ì‹œìŠ¤í…œ (Foundry) | âœ… ë°°í¬ë¨ |\n",
    "| Main Agent | Task ë¶„ì„ ë° ë¼ìš°íŒ… | âœ… ì‘ë™ ì¤‘ |\n",
    "| Tool Agent | MCP ë„êµ¬ ì—°ë™ (ë‚ ì”¨ ë“±) | âœ… ì‘ë™ ì¤‘ |\n",
    "| Research Agent | RAG ê¸°ë°˜ ì§€ì‹ ê²€ìƒ‰ | âœ… ì‘ë™ ì¤‘ |\n",
    "| Azure AI Search Connection | RAG ë°ì´í„° ì†ŒìŠ¤ | âœ… ì—°ê²°ë¨ |\n",
    "| Application Insights | Analytics ë° Tracing | âœ… í™œì„±í™” |\n",
    "\n",
    "### ğŸ“ ì¤‘ìš” ì‚¬í•­\n",
    "\n",
    "**í˜„ì¬ ì™„ë£Œëœ ì‘ì—…:**\n",
    "- âœ… MCP Server Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ ì™„ë£Œ\n",
    "- âœ… Agent Service Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ ì™„ë£Œ\n",
    "- âœ… Managed Identity ê¶Œí•œ ì„¤ì • ì™„ë£Œ (Azure AI User)\n",
    "- âœ… Multi-Agent ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì™„ë£Œ\n",
    "- âœ… Application Analytics ë° Tracing í™œì„±í™”\n",
    "\n",
    "**Agent ì—”ë“œí¬ì¸íŠ¸:**\n",
    "- ğŸŒ Agent Service: `{AGENT_ENDPOINT}/chat` (POST)\n",
    "- ğŸŒ MCP Server: `{MCP_ENDPOINT}/mcp` (POST)\n",
    "\n",
    "**Analytics í™•ì¸:**\n",
    "- ğŸ“Š 5-10ë¶„ í›„ [Azure AI Foundry Portal](https://ai.azure.com)ì—ì„œ í™•ì¸\n",
    "- í”„ë¡œì íŠ¸ â†’ í‰ê°€ â†’ Application Analytics\n",
    "- Tracing íƒ­ì—ì„œ ìƒì„¸ ì‹¤í–‰ ë¡œê·¸ í™•ì¸ ê°€ëŠ¥\n",
    "\n",
    "### ë‹¤ìŒ ë‹¨ê³„ (Next Steps)\n",
    "\n",
    "ì´ì œ ë‹¤ìŒ ë…¸íŠ¸ë¶ìœ¼ë¡œ ì§„í–‰í•˜ì„¸ìš”:\n",
    "\n",
    "1. **Notebook 4: Agent Framework Workflow ë°°í¬** (`04_deploy_agent_framework.ipynb`)\n",
    "   - Microsoft Agent Framework (LangGraph ê¸°ë°˜) ë°°í¬\n",
    "   - Workflow Patternìœ¼ë¡œ Multi-Agent êµ¬ì„±\n",
    "   - Router Executorë¥¼ í†µí•œ AI ê¸°ë°˜ ì¸í…íŠ¸ ë¶„ë¥˜\n",
    "   - Workflow Context ê¸°ë°˜ ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¬ë°\n",
    "   - Foundry Agent vs Framework Agent ë¹„êµ\n",
    "\n",
    "**ì„ íƒ ì‚¬í•­:**\n",
    "- í˜„ì¬ ë°°í¬ëœ Foundry Agentë¥¼ ê³„ì† ì‚¬ìš©í•˜ê±°ë‚˜\n",
    "- Framework Agentë¥¼ ì¶”ê°€ë¡œ ë°°í¬í•˜ì—¬ ë‘ íŒ¨í„´ ë¹„êµ ê°€ëŠ¥\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "41a2a642",
   "metadata": {},
   "source": [
    "## 13. Agent Evaluation ì„¤ì • (Agent Evaluation Setup)\n",
    "\n",
    "Azure AI FoundryëŠ” Agentì˜ í’ˆì§ˆ, íš¨ìœ¨ì„±, ìœ„í—˜ì„±ì„ ì¸¡ì •í•˜ëŠ” ë‹¤ì–‘í•œ ë‚´ì¥ evaluatorë¥¼ ì œê³µí•©ë‹ˆë‹¤.\n",
    "\n",
    "### Evaluation ìœ í˜•\n",
    "\n",
    "**Performance Evaluators (ì„±ëŠ¥ í‰ê°€):**\n",
    "- **Intent Resolution**: Agentê°€ ì‚¬ìš©ì ì˜ë„ë¥¼ ì˜¬ë°”ë¥´ê²Œ íŒŒì•…í–ˆëŠ”ì§€ í‰ê°€\n",
    "- **Tool Call Accuracy**: Agentê°€ ì˜¬ë°”ë¥¸ ë„êµ¬ë¥¼ ì •í™•í•˜ê²Œ í˜¸ì¶œí–ˆëŠ”ì§€ í‰ê°€  \n",
    "- **Task Adherence**: Agentê°€ ì§€ì‹œì‚¬í•­ì„ ì¶©ì‹¤íˆ ë”°ëëŠ”ì§€ í‰ê°€\n",
    "\n",
    "**Safety Evaluators (ì•ˆì „ì„± í‰ê°€):**\n",
    "- **Content Safety**: ë¶€ì ì ˆí•œ ì½˜í…ì¸ (í­ë ¥, í˜ì˜¤ ë“±) í¬í•¨ ì—¬ë¶€ í‰ê°€\n",
    "- **Indirect Attack**: ê°„ì ‘ì ì¸ ì•…ì˜ì  ê³µê²© ì‹œë„ ê°ì§€\n",
    "- **Code Vulnerability**: ìƒì„±ëœ ì½”ë“œì˜ ë³´ì•ˆ ì·¨ì•½ì  í‰ê°€\n",
    "\n",
    "### Evaluation ë°ì´í„°\n",
    "\n",
    "Evaluationì€ í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì§‘í•©(`eval-queries.json`)ì„ Agentì— ì‹¤í–‰í•˜ì—¬ ì§„í–‰ë©ë‹ˆë‹¤:\n",
    "\n",
    "**í•„ìˆ˜ í•„ë“œ:**\n",
    "- `query`: Agentì— ë³´ë‚¼ í…ŒìŠ¤íŠ¸ ì§ˆë¬¸\n",
    "- `ground-truth` (ì„ íƒ): ì˜ˆìƒ ë‹µë³€ (ì¼ë¶€ evaluatorì—ì„œ ì‚¬ìš©)\n",
    "\n",
    "**Evaluation í”„ë¡œì„¸ìŠ¤:**\n",
    "1. ê° queryë¥¼ Agentì— ì „ì†¡\n",
    "2. Agent ì‘ë‹µ ìˆ˜ì§‘ ë° ì‹¤í–‰ ë©”íŠ¸ë¦­ ì¸¡ì •\n",
    "3. Evaluatorë“¤ì´ ì‘ë‹µ í’ˆì§ˆ í‰ê°€\n",
    "4. ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥ ë° AI Foundryì— ì—…ë¡œë“œ\n",
    "\n",
    "### í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜\n",
    "\n",
    "- `AZURE_EXISTING_AIPROJECT_ENDPOINT`: AI Project endpoint  \n",
    "- `AZURE_AI_AGENT_DEPLOYMENT_NAME`: Evaluatorìš© ëª¨ë¸ ë°°í¬ëª…\n",
    "- `AZURE_EXISTING_AGENT_ID` ë˜ëŠ” `AZURE_AI_AGENT_NAME`: í‰ê°€í•  Agent ID/ì´ë¦„\n",
    "\n",
    "> ğŸ’¡ **ì°¸ê³ **: ì´ë¯¸ `.env` íŒŒì¼ì— ì„¤ì •ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë³„ë„ ì„¤ì •ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "da1dea38",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Creating Evaluation Test Queries ===\n",
      "\n",
      "âœ… Created evals/eval-queries.json\n",
      "\n",
      "ğŸ“‹ Test Queries (5 total):\n",
      "\n",
      "   1. ì•ˆë…•í•˜ì„¸ìš”. ê°€ì¡± ì—¬í–‰ì§€ë¥¼ ì¶”ì²œë°›ê³  ì‹¶ì–´ìš”....\n",
      "   2. ë¶€ì‚°ì˜ í˜„ì¬ ë‚ ì”¨ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ì˜¨ë„ì™€ ì²´ê°ì˜¨ë„ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”....\n",
      "   3. ì œì£¼ë„ì—ì„œ ê°€ì¡±ê³¼ í•¨ê»˜ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ì—¬í–‰ì§€ëŠ” ì–´ë””ì¸ê°€ìš”?...\n",
      "   4. ì„œí•‘í•  ìˆ˜ ìˆëŠ” í•´ë³€ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”....\n",
      "   5. ê°€ì„ì— ê°€ê¸° ì¢‹ì€ ë‹¨í’ ëª…ì†ŒëŠ” ì–´ë””ì¸ê°€ìš”?...\n",
      "\n",
      "ğŸ’¡ ê° ì¿¼ë¦¬ëŠ” Agentì˜ ë‹¤ë¥¸ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤:\n",
      "   â€¢ ì¼ë°˜ ëŒ€í™” ë° ì—¬í–‰ ì˜ë„ íŒŒì•… (Main Agent)\n",
      "   â€¢ ë‚ ì”¨ ì¡°íšŒ (Tool Agent - MCP)\n",
      "   â€¢ ì—¬í–‰ì§€ ì§€ì‹ ê²€ìƒ‰ (Research Agent - RAG)\n",
      "\n",
      "============================================================\n"
     ]
    }
   ],
   "source": [
    "# evals ë””ë ‰í† ë¦¬ ìƒì„±\n",
    "import os\n",
    "from pathlib import Path\n",
    "\n",
    "evals_dir = Path(\"evals\")\n",
    "evals_dir.mkdir(exist_ok=True)\n",
    "\n",
    "print(\"=== Creating Evaluation Test Queries ===\\n\")\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì •ì˜\n",
    "eval_queries = [\n",
    "    {\n",
    "        \"query\": \"ì•ˆë…•í•˜ì„¸ìš”. ê°€ì¡± ì—¬í–‰ì§€ë¥¼ ì¶”ì²œë°›ê³  ì‹¶ì–´ìš”.\",\n",
    "        \"ground-truth\": \"AgentëŠ” ì¸ì‚¬ì— ì‘ë‹µí•˜ê³ , ì—¬í–‰ì§€ ì¶”ì²œì„ ìœ„í•´ Research Agentë¥¼ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.\"\n",
    "    },\n",
    "    {\n",
    "        \"query\": \"ë¶€ì‚°ì˜ í˜„ì¬ ë‚ ì”¨ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ì˜¨ë„ì™€ ì²´ê°ì˜¨ë„ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”.\",\n",
    "        \"ground-truth\": \"ë¶€ì‚°ì˜ í˜„ì¬ ë‚ ì”¨ ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ì œê³µí•´ì•¼ í•˜ë©°, ì˜¨ë„ì™€ ì²´ê°ì˜¨ë„ë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.\"\n",
    "    },\n",
    "    {\n",
    "        \"query\": \"ì œì£¼ë„ì—ì„œ ê°€ì¡±ê³¼ í•¨ê»˜ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ì—¬í–‰ì§€ëŠ” ì–´ë””ì¸ê°€ìš”?\",\n",
    "        \"ground-truth\": \"ì œì£¼ë„ì˜ ê°€ì¡± ì¹œí™”ì ì¸ ì—¬í–‰ì§€ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤. ìì—° ëª…ì†Œ, ì²´í—˜ í™œë™, ì ‘ê·¼ì„± ë“±ì„ ê³ ë ¤í•œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\"\n",
    "    },\n",
    "    {\n",
    "        \"query\": \"ì„œí•‘í•  ìˆ˜ ìˆëŠ” í•´ë³€ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”.\",\n",
    "        \"ground-truth\": \"ì„œí•‘ì´ ê°€ëŠ¥í•œ í•œêµ­ì˜ í•´ë³€ ì—¬í–‰ì§€ë¥¼ ê²€ìƒ‰í•˜ì—¬ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤. ì–‘ì–‘, ë¶€ì‚° ë“±ì˜ ì„œí•‘ ëª…ì†Œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\"\n",
    "    },\n",
    "    {\n",
    "        \"query\": \"ê°€ì„ì— ê°€ê¸° ì¢‹ì€ ë‹¨í’ ëª…ì†ŒëŠ” ì–´ë””ì¸ê°€ìš”?\",\n",
    "        \"ground-truth\": \"ê°€ì„ ê³„ì ˆì— ë°©ë¬¸í•˜ê¸° ì¢‹ì€ ë‹¨í’ ëª…ì†Œë¥¼ ê²€ìƒ‰í•˜ì—¬ ì¶”ì²œí•´ì•¼ í•©ë‹ˆë‹¤. ë‚´ì¥ì‚°, ì„¤ì•…ì‚° ë“±ì˜ ìì—° ëª…ì†Œ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\"\n",
    "    }\n",
    "]\n",
    "\n",
    "# JSON íŒŒì¼ë¡œ ì €ì¥\n",
    "eval_queries_path = evals_dir / \"eval-queries.json\"\n",
    "with open(eval_queries_path, 'w', encoding='utf-8') as f:\n",
    "    json.dump(eval_queries, f, indent=2, ensure_ascii=False)\n",
    "\n",
    "print(f\"âœ… Created {eval_queries_path}\")\n",
    "print(f\"\\nğŸ“‹ Test Queries ({len(eval_queries)} total):\\n\")\n",
    "\n",
    "for i, query in enumerate(eval_queries, 1):\n",
    "    print(f\"   {i}. {query['query'][:60]}...\")\n",
    "\n",
    "print(\"\\nğŸ’¡ ê° ì¿¼ë¦¬ëŠ” Agentì˜ ë‹¤ë¥¸ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤:\")\n",
    "print(\"   â€¢ ì¼ë°˜ ëŒ€í™” ë° ì—¬í–‰ ì˜ë„ íŒŒì•… (Main Agent)\")\n",
    "print(\"   â€¢ ë‚ ì”¨ ì¡°íšŒ (Tool Agent - MCP)\")\n",
    "print(\"   â€¢ ì—¬í–‰ì§€ ì§€ì‹ ê²€ìƒ‰ (Research Agent - RAG)\")\n",
    "\n",
    "print(\"\\n\" + \"=\"*60)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "63005287",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "=== Running Agent Evaluation ===\n",
      "\n",
      "ğŸ“‹ Configuration:\n",
      "   Project: https://aoai-f5gn2xuprfeyy.services.ai.azure.com/api/projects/proj-f5gn2xuprfeyy\n",
      "   Model: gpt-4o\n",
      "   Test Queries: evals/eval-queries.json\n",
      "\n",
      "\n",
      "ğŸ”Œ Connecting to AI Project...\n",
      "âœ… Connected\n",
      "\n",
      "ğŸ¤– Creating Evaluation Agent...\n",
      "âœ… Agent created: Evaluation Agent (ID: asst_RAZ6p3qDj1nHJZwzs8944esV)\n",
      "\n",
      "======================================================================\n",
      "ğŸ“ Executing Test Queries\n",
      "\n",
      "   Total queries: 5\n",
      "\n",
      "   [1/5] ì•ˆë…•í•˜ì„¸ìš”. ê°€ì¡± ì—¬í–‰ì§€ë¥¼ ì¶”ì²œë°›ê³  ì‹¶ì–´ìš”....\n",
      "âœ… Agent created: Evaluation Agent (ID: asst_RAZ6p3qDj1nHJZwzs8944esV)\n",
      "\n",
      "======================================================================\n",
      "ğŸ“ Executing Test Queries\n",
      "\n",
      "   Total queries: 5\n",
      "\n",
      "   [1/5] ì•ˆë…•í•˜ì„¸ìš”. ê°€ì¡± ì—¬í–‰ì§€ë¥¼ ì¶”ì²œë°›ê³  ì‹¶ì–´ìš”....\n",
      "      âœ… Completed in 18.7s\n",
      "         Tokens: 112 prompt + 1040 completion\n",
      "\n",
      "   [2/5] ë¶€ì‚°ì˜ í˜„ì¬ ë‚ ì”¨ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ì˜¨ë„ì™€ ì²´ê°ì˜¨ë„ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”....\n",
      "      âœ… Completed in 18.7s\n",
      "         Tokens: 112 prompt + 1040 completion\n",
      "\n",
      "   [2/5] ë¶€ì‚°ì˜ í˜„ì¬ ë‚ ì”¨ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. ì˜¨ë„ì™€ ì²´ê°ì˜¨ë„ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”....\n",
      "      âœ… Completed in 6.8s\n",
      "         Tokens: 120 prompt + 309 completion\n",
      "\n",
      "   [3/5] ì œì£¼ë„ì—ì„œ ê°€ì¡±ê³¼ í•¨ê»˜ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ì—¬í–‰ì§€ëŠ” ì–´ë””ì¸ê°€ìš”?...\n",
      "      âœ… Completed in 6.8s\n",
      "         Tokens: 120 prompt + 309 completion\n",
      "\n",
      "   [3/5] ì œì£¼ë„ì—ì„œ ê°€ì¡±ê³¼ í•¨ê»˜ ì¦ê¸¸ ìˆ˜ ìˆëŠ” ì—¬í–‰ì§€ëŠ” ì–´ë””ì¸ê°€ìš”?...\n",
      "      âœ… Completed in 18.3s\n",
      "         Tokens: 117 prompt + 1174 completion\n",
      "\n",
      "   [4/5] ì„œí•‘í•  ìˆ˜ ìˆëŠ” í•´ë³€ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”....\n",
      "      âœ… Completed in 18.3s\n",
      "         Tokens: 117 prompt + 1174 completion\n",
      "\n",
      "   [4/5] ì„œí•‘í•  ìˆ˜ ìˆëŠ” í•´ë³€ì„ ì¶”ì²œí•´ì£¼ì„¸ìš”....\n",
      "      âœ… Completed in 15.9s\n",
      "         Tokens: 111 prompt + 901 completion\n",
      "\n",
      "   [5/5] ê°€ì„ì— ê°€ê¸° ì¢‹ì€ ë‹¨í’ ëª…ì†ŒëŠ” ì–´ë””ì¸ê°€ìš”?...\n",
      "      âœ… Completed in 15.9s\n",
      "         Tokens: 111 prompt + 901 completion\n",
      "\n",
      "   [5/5] ê°€ì„ì— ê°€ê¸° ì¢‹ì€ ë‹¨í’ ëª…ì†ŒëŠ” ì–´ë””ì¸ê°€ìš”?...\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Class ToolCallAccuracyEvaluator: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.\n",
      "Class IntentResolutionEvaluator: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.\n",
      "Class IntentResolutionEvaluator: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.\n",
      "Class TaskAdherenceEvaluator: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.\n",
      "Class TaskAdherenceEvaluator: This is an experimental class, and may change at any time. Please see https://aka.ms/azuremlexperimental for more information.\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "      âœ… Completed in 18.1s\n",
      "         Tokens: 115 prompt + 1149 completion\n",
      "\n",
      "======================================================================\n",
      "\n",
      "âœ… All queries executed successfully\n",
      "   Input saved to: evals/eval-input.jsonl\n",
      "\n",
      "======================================================================\n",
      "ğŸ”¬ Running Evaluators\n",
      "\n",
      "   Evaluators:\n",
      "      â€¢ ToolCallAccuracyEvaluator\n",
      "      â€¢ IntentResolutionEvaluator\n",
      "      â€¢ TaskAdherenceEvaluator\n",
      "\n",
      "   âš ï¸  ì°¸ê³ : eastus ë¦¬ì „ì—ì„œëŠ” ì¼ë¶€ RAI í‰ê°€ìê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n",
      "      (CodeVulnerability, ContentSafety, IndirectAttackëŠ” ì œì™¸)\n",
      "\n",
      "   â³ This may take 1-2 minutes...\n",
      "\n",
      "2025-10-20 16:37:06 +0900 6256078848 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:06 +0900 6256078848 execution.bulk     INFO     Average execution time for completed lines: 0.0 seconds. Estimated time for incomplete lines: 0.0 seconds.\n",
      "2025-10-20 16:37:06 +0900 6239252480 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:06 +0900 6239252480 execution.bulk     INFO     Average execution time for completed lines: 0.0 seconds. Estimated time for incomplete lines: 0.0 seconds.\n",
      "2025-10-20 16:37:06 +0900 6256078848 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:06 +0900 6256078848 execution.bulk     INFO     Average execution time for completed lines: 0.0 seconds. Estimated time for incomplete lines: 0.0 seconds.\n",
      "2025-10-20 16:37:06 +0900 6239252480 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:06 +0900 6239252480 execution.bulk     INFO     Average execution time for completed lines: 0.0 seconds. Estimated time for incomplete lines: 0.0 seconds.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Aggregated metrics for evaluator is not a dictionary will not be logged as metrics\n",
      "Aggregated metrics for evaluator is not a dictionary will not be logged as metrics\n",
      "Aggregated metrics for evaluator is not a dictionary will not be logged as metrics\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "======= Run Summary =======\n",
      "\n",
      "Run name: \"tool_call_accuracy_20251020_073706_413222\"\n",
      "Run status: \"Completed\"\n",
      "Start time: \"2025-10-20 07:37:06.413222+00:00\"\n",
      "Duration: \"0:00:01.002365\"\n",
      "\n",
      "======= Run Summary =======\n",
      "\n",
      "Run name: \"operational_metrics_20251020_073706_414637\"\n",
      "Run status: \"Completed\"\n",
      "Start time: \"2025-10-20 07:37:06.414637+00:00\"\n",
      "Duration: \"0:00:01.001754\"\n",
      "\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 1 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 5.17 seconds. Estimated time for incomplete lines: 20.68 seconds.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 1 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 5.17 seconds. Estimated time for incomplete lines: 20.68 seconds.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 2 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 2.6 seconds. Estimated time for incomplete lines: 7.8 seconds.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 2 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 2.6 seconds. Estimated time for incomplete lines: 7.8 seconds.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 3 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 1.79 seconds. Estimated time for incomplete lines: 3.58 seconds.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 3 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 1.79 seconds. Estimated time for incomplete lines: 3.58 seconds.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 4 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 1.39 seconds. Estimated time for incomplete lines: 1.39 seconds.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Finished 4 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 1.39 seconds. Estimated time for incomplete lines: 1.39 seconds.\n",
      "2025-10-20 16:37:11 +0900 6289731584 execution.bulk     INFO     Finished 1 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 5.57 seconds. Estimated time for incomplete lines: 22.28 seconds.\n",
      "2025-10-20 16:37:11 +0900 6289731584 execution.bulk     INFO     Finished 1 / 5 lines.\n",
      "2025-10-20 16:37:11 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 5.57 seconds. Estimated time for incomplete lines: 22.28 seconds.\n",
      "2025-10-20 16:37:12 +0900 6272905216 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 1.24 seconds. Estimated time for incomplete lines: 0.0 seconds.\n",
      "2025-10-20 16:37:12 +0900 6272905216 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6272905216 execution.bulk     INFO     Average execution time for completed lines: 1.24 seconds. Estimated time for incomplete lines: 0.0 seconds.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Finished 2 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 3.16 seconds. Estimated time for incomplete lines: 9.48 seconds.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Finished 2 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 3.16 seconds. Estimated time for incomplete lines: 9.48 seconds.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Finished 3 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 2.14 seconds. Estimated time for incomplete lines: 4.28 seconds.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Finished 3 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 2.14 seconds. Estimated time for incomplete lines: 4.28 seconds.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Finished 4 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 1.61 seconds. Estimated time for incomplete lines: 1.61 seconds.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Finished 4 / 5 lines.\n",
      "2025-10-20 16:37:12 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 1.61 seconds. Estimated time for incomplete lines: 1.61 seconds.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Aggregated metrics for evaluator is not a dictionary will not be logged as metrics\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "======= Run Summary =======\n",
      "\n",
      "Run name: \"intent_resolution_20251020_073706_417623\"\n",
      "Run status: \"Completed\"\n",
      "Start time: \"2025-10-20 07:37:06.417623+00:00\"\n",
      "Duration: \"0:00:06.523665\"\n",
      "\n",
      "2025-10-20 16:37:13 +0900 6289731584 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:13 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 1.37 seconds. Estimated time for incomplete lines: 0.0 seconds.\n",
      "2025-10-20 16:37:13 +0900 6289731584 execution.bulk     INFO     Finished 5 / 5 lines.\n",
      "2025-10-20 16:37:13 +0900 6289731584 execution.bulk     INFO     Average execution time for completed lines: 1.37 seconds. Estimated time for incomplete lines: 0.0 seconds.\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "Aggregated metrics for evaluator is not a dictionary will not be logged as metrics\n"
     ]
    },
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "======= Run Summary =======\n",
      "\n",
      "Run name: \"task_adherence_20251020_073706_418545\"\n",
      "Run status: \"Completed\"\n",
      "Start time: \"2025-10-20 07:37:06.418545+00:00\"\n",
      "Duration: \"0:00:07.522714\"\n",
      "\n",
      "======= Combined Run Summary (Per Evaluator) =======\n",
      "\n",
      "{\n",
      "    \"operational_metrics\": {\n",
      "        \"status\": \"Completed\",\n",
      "        \"duration\": \"0:00:01.001754\",\n",
      "        \"completed_lines\": 5,\n",
      "        \"failed_lines\": 0,\n",
      "        \"log_path\": null\n",
      "    },\n",
      "    \"tool_call_accuracy\": {\n",
      "        \"status\": \"Completed\",\n",
      "        \"duration\": \"0:00:01.002365\",\n",
      "        \"completed_lines\": 5,\n",
      "        \"failed_lines\": 0,\n",
      "        \"log_path\": null\n",
      "    },\n",
      "    \"intent_resolution\": {\n",
      "        \"status\": \"Completed\",\n",
      "        \"duration\": \"0:00:06.523665\",\n",
      "        \"completed_lines\": 5,\n",
      "        \"failed_lines\": 0,\n",
      "        \"log_path\": null\n",
      "    },\n",
      "    \"task_adherence\": {\n",
      "        \"status\": \"Completed\",\n",
      "        \"duration\": \"0:00:07.522714\",\n",
      "        \"completed_lines\": 5,\n",
      "        \"failed_lines\": 0,\n",
      "        \"log_path\": null\n",
      "    }\n",
      "}\n",
      "\n",
      "====================================================\n",
      "\n",
      "Evaluation results saved to \"/Users/junwoojeong/GitHub/agentic-ai-labs/evals/eval-output.json\".\n",
      "\n",
      "âœ… Evaluation completed!\n",
      "\n",
      "ğŸ§¹ Cleaning up...\n",
      "âœ… Evaluation Agent deleted: asst_RAZ6p3qDj1nHJZwzs8944esV\n",
      "\n",
      "======================================================================\n"
     ]
    }
   ],
   "source": [
    "# Agent Evaluation ì‹¤í–‰\n",
    "import time\n",
    "from pathlib import Path\n",
    "from urllib.parse import urlparse\n",
    "from azure.ai.agents.models import RunStatus, MessageRole\n",
    "from azure.ai.projects import AIProjectClient\n",
    "from azure.ai.evaluation import (\n",
    "    AIAgentConverter, evaluate, ToolCallAccuracyEvaluator, IntentResolutionEvaluator, \n",
    "    TaskAdherenceEvaluator\n",
    ")\n",
    "from azure.identity import DefaultAzureCredential\n",
    "\n",
    "print(\"=== Running Agent Evaluation ===\\n\")\n",
    "\n",
    "# íŒŒì¼ ê²½ë¡œ ì„¤ì •\n",
    "current_dir = Path(\".\")\n",
    "evals_dir = current_dir / \"evals\"\n",
    "eval_queries_path = evals_dir / \"eval-queries.json\"\n",
    "eval_input_path = evals_dir / \"eval-input.jsonl\"\n",
    "eval_output_path = evals_dir / \"eval-output.json\"\n",
    "\n",
    "# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (ì´ë¯¸ configì—ì„œ ë¡œë“œë¨)\n",
    "project_endpoint = simple_project_conn\n",
    "parsed_endpoint = urlparse(project_endpoint)\n",
    "model_endpoint = f\"{parsed_endpoint.scheme}://{parsed_endpoint.netloc}\"\n",
    "deployment_name = config.get(\"model_deployment_name\", \"gpt-4o\")\n",
    "\n",
    "print(f\"ğŸ“‹ Configuration:\")\n",
    "print(f\"   Project: {project_endpoint}\")\n",
    "print(f\"   Model: {deployment_name}\")\n",
    "print(f\"   Test Queries: {eval_queries_path}\")\n",
    "print(f\"\\n\")\n",
    "\n",
    "# Initialize AIProjectClient\n",
    "print(\"ğŸ”Œ Connecting to AI Project...\")\n",
    "credential = DefaultAzureCredential()\n",
    "ai_project = AIProjectClient(\n",
    "    credential=credential,\n",
    "    endpoint=project_endpoint,\n",
    "    api_version=\"2025-05-15-preview\"  # Evaluations require preview API\n",
    ")\n",
    "print(\"âœ… Connected\\n\")\n",
    "\n",
    "# Evaluationìš© Agent ìƒì„±\n",
    "print(\"ğŸ¤– Creating Evaluation Agent...\")\n",
    "eval_agent = ai_project.agents.create_agent(\n",
    "    model=deployment_name,\n",
    "    name=\"Evaluation Agent\",\n",
    "    instructions=\"\"\"You are a helpful travel and weather assistant.\n",
    "    \n",
    "You can help users with:\n",
    "1. Travel recommendations and destination information\n",
    "2. Weather information for any city\n",
    "3. General travel planning advice\n",
    "\n",
    "Be friendly, informative, and provide detailed responses.\"\"\"\n",
    ")\n",
    "print(f\"âœ… Agent created: {eval_agent.name} (ID: {eval_agent.id})\\n\")\n",
    "\n",
    "# Setup evaluation config\n",
    "api_version = config.get(\"api_version\", \"2024-08-01-preview\")\n",
    "model_config = {\n",
    "    \"azure_deployment\": deployment_name,\n",
    "    \"azure_endpoint\": model_endpoint,\n",
    "    \"api_version\": api_version,\n",
    "}\n",
    "\n",
    "thread_data_converter = AIAgentConverter(ai_project)\n",
    "\n",
    "# í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰ ë° evaluation input ì¤€ë¹„\n",
    "print(\"=\"*70)\n",
    "print(\"ğŸ“ Executing Test Queries\\n\")\n",
    "\n",
    "with open(eval_queries_path, \"r\", encoding=\"utf-8\") as f:\n",
    "    test_data = json.load(f)\n",
    "\n",
    "print(f\"   Total queries: {len(test_data)}\\n\")\n",
    "\n",
    "with open(eval_input_path, \"w\", encoding=\"utf-8\") as f:\n",
    "    for idx, row in enumerate(test_data, 1):\n",
    "        query_text = row.get(\"query\")\n",
    "        print(f\"   [{idx}/{len(test_data)}] {query_text[:50]}...\")\n",
    "        \n",
    "        # ìƒˆ ìŠ¤ë ˆë“œ ìƒì„± (ê° ì¿¼ë¦¬ë¥¼ ê²©ë¦¬)\n",
    "        thread = ai_project.agents.threads.create()\n",
    "        \n",
    "        # ì‚¬ìš©ì ì¿¼ë¦¬ ìƒì„±\n",
    "        ai_project.agents.messages.create(\n",
    "            thread.id, role=MessageRole.USER, content=query_text\n",
    "        )\n",
    "        \n",
    "        # Agent ì‹¤í–‰ ë° ì„±ëŠ¥ ì¸¡ì •\n",
    "        start_time = time.time()\n",
    "        run = ai_project.agents.runs.create_and_process(\n",
    "            thread_id=thread.id, agent_id=eval_agent.id\n",
    "        )\n",
    "        end_time = time.time()\n",
    "        \n",
    "        if run.status != RunStatus.COMPLETED:\n",
    "            print(f\"      âš ï¸  Run failed: {run.last_error or 'Unknown error'}\")\n",
    "            continue\n",
    "        \n",
    "        # ìš´ì˜ ë©”íŠ¸ë¦­ ìˆ˜ì§‘\n",
    "        operational_metrics = {\n",
    "            \"server-run-duration-in-seconds\": (\n",
    "                run.completed_at - run.created_at\n",
    "            ).total_seconds(),\n",
    "            \"client-run-duration-in-seconds\": end_time - start_time,\n",
    "            \"completion-tokens\": run.usage.completion_tokens,\n",
    "            \"prompt-tokens\": run.usage.prompt_tokens,\n",
    "            \"ground-truth\": row.get(\"ground-truth\", '')\n",
    "        }\n",
    "        \n",
    "        # Thread ë°ì´í„° + ìš´ì˜ ë©”íŠ¸ë¦­ì„ evaluation inputì— ì¶”ê°€\n",
    "        evaluation_data = thread_data_converter.prepare_evaluation_data(thread_ids=thread.id)\n",
    "        eval_item = evaluation_data[0]\n",
    "        eval_item[\"metrics\"] = operational_metrics\n",
    "        f.write(json.dumps(eval_item, ensure_ascii=False) + \"\\n\")\n",
    "        \n",
    "        print(f\"      âœ… Completed in {operational_metrics['client-run-duration-in-seconds']:.1f}s\")\n",
    "        print(f\"         Tokens: {operational_metrics['prompt-tokens']} prompt + {operational_metrics['completion-tokens']} completion\\n\")\n",
    "\n",
    "print(\"=\"*70)\n",
    "print(\"\\nâœ… All queries executed successfully\")\n",
    "print(f\"   Input saved to: {eval_input_path}\\n\")\n",
    "\n",
    "# Evaluation ì‹¤í–‰\n",
    "print(\"=\"*70)\n",
    "print(\"ğŸ”¬ Running Evaluators\\n\")\n",
    "\n",
    "print(\"   Evaluators:\")\n",
    "print(\"      â€¢ ToolCallAccuracyEvaluator\")\n",
    "print(\"      â€¢ IntentResolutionEvaluator\")\n",
    "print(\"      â€¢ TaskAdherenceEvaluator\")\n",
    "print(\"\\n   âš ï¸  ì°¸ê³ : eastus ë¦¬ì „ì—ì„œëŠ” ì¼ë¶€ RAI í‰ê°€ìê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\")\n",
    "print(\"      (CodeVulnerability, ContentSafety, IndirectAttackëŠ” ì œì™¸)\\n\")\n",
    "print(\"   â³ This may take 1-2 minutes...\\n\")\n",
    "\n",
    "# OperationalMetricsEvaluator ì •ì˜\n",
    "class OperationalMetricsEvaluator:\n",
    "    \"\"\"Propagate operational metrics to the final evaluation results\"\"\"\n",
    "    def __init__(self):\n",
    "        pass\n",
    "    def __call__(self, *, metrics: dict, **kwargs):\n",
    "        return metrics\n",
    "\n",
    "# Evaluation ì‹¤í–‰ (ë¦¬ì „ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠëŠ” í‰ê°€ì ì œì™¸)\n",
    "results = evaluate(\n",
    "    evaluation_name=\"foundry-agent-evaluation\",\n",
    "    data=eval_input_path,\n",
    "    evaluators={\n",
    "        \"operational_metrics\": OperationalMetricsEvaluator(),\n",
    "        \"tool_call_accuracy\": ToolCallAccuracyEvaluator(model_config=model_config),\n",
    "        \"intent_resolution\": IntentResolutionEvaluator(model_config=model_config),\n",
    "        \"task_adherence\": TaskAdherenceEvaluator(model_config=model_config),\n",
    "        # eastus ë¦¬ì „ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠëŠ” í‰ê°€ìë“¤ì€ ì œì™¸\n",
    "        # \"code_vulnerability\": CodeVulnerabilityEvaluator(credential=credential, azure_ai_project=project_endpoint),\n",
    "        # \"content_safety\": ContentSafetyEvaluator(credential=credential, azure_ai_project=project_endpoint),\n",
    "        # \"indirect_attack\": IndirectAttackEvaluator(credential=credential, azure_ai_project=project_endpoint)\n",
    "    },\n",
    "    output_path=eval_output_path,\n",
    "    # azure_ai_project íŒŒë¼ë¯¸í„°ë¥¼ ì œê±°í•˜ì—¬ ë¡œì»¬ì—ì„œë§Œ í‰ê°€ ì‹¤í–‰ (ê¶Œí•œ ë¬¸ì œ íšŒí”¼)\n",
    "    # azure_ai_project=project_endpoint,\n",
    ")\n",
    "\n",
    "print(\"âœ… Evaluation completed!\\n\")\n",
    "\n",
    "# Evaluation Agent ì‚­ì œ\n",
    "print(\"ğŸ§¹ Cleaning up...\")\n",
    "ai_project.agents.delete_agent(eval_agent.id)\n",
    "print(f\"âœ… Evaluation Agent deleted: {eval_agent.id}\\n\")\n",
    "\n",
    "print(\"=\"*70)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "c1435c17",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Evaluation ê²°ê³¼ í‘œì‹œ\n",
    "def print_eval_results(results, input_path, output_path):\n",
    "    \"\"\"Print the evaluation results in a formatted table\"\"\"\n",
    "    metrics = results.get(\"metrics\", {})\n",
    "    \n",
    "    if not metrics:\n",
    "        print(\"âŒ No metrics found in results\")\n",
    "        return\n",
    "    \n",
    "    # Get the maximum length for formatting\n",
    "    key_len = max(len(key) for key in metrics.keys()) + 5\n",
    "    value_len = 20\n",
    "    full_len = key_len + value_len + 5\n",
    "    \n",
    "    # Format the header\n",
    "    print(\"\\n\" + \"=\" * full_len)\n",
    "    print(\"Evaluation Results\".center(full_len))\n",
    "    print(\"=\" * full_len)\n",
    "    \n",
    "    # Categorize metrics\n",
    "    operational = {}\n",
    "    performance = {}\n",
    "    safety = {}\n",
    "    \n",
    "    for key, value in metrics.items():\n",
    "        if any(x in key for x in ['duration', 'tokens', 'ground-truth']):\n",
    "            operational[key] = value\n",
    "        elif any(x in key for x in ['vulnerability', 'safety', 'attack']):\n",
    "            safety[key] = value\n",
    "        else:\n",
    "            performance[key] = value\n",
    "    \n",
    "    # Print operational metrics\n",
    "    if operational:\n",
    "        print(\"\\nğŸ“Š Operational Metrics\")\n",
    "        print(\"-\" * full_len)\n",
    "        for key, value in sorted(operational.items()):\n",
    "            if isinstance(value, float):\n",
    "                formatted_value = f\"{value:.2f}\"\n",
    "            else:\n",
    "                formatted_value = str(value)\n",
    "            print(f\"{key:<{key_len}} | {formatted_value}\")\n",
    "    \n",
    "    # Print performance metrics\n",
    "    if performance:\n",
    "        print(\"\\nâš¡ Performance Metrics\")\n",
    "        print(\"-\" * full_len)\n",
    "        for key, value in sorted(performance.items()):\n",
    "            if isinstance(value, float):\n",
    "                formatted_value = f\"{value:.2f}\"\n",
    "            else:\n",
    "                formatted_value = str(value)\n",
    "            print(f\"{key:<{key_len}} | {formatted_value}\")\n",
    "    \n",
    "    # Print safety metrics\n",
    "    if safety:\n",
    "        print(\"\\nğŸ›¡ï¸  Safety Metrics\")\n",
    "        print(\"-\" * full_len)\n",
    "        for key, value in sorted(safety.items()):\n",
    "            if isinstance(value, float):\n",
    "                formatted_value = f\"{value:.2f}\"\n",
    "            else:\n",
    "                formatted_value = str(value)\n",
    "            print(f\"{key:<{key_len}} | {formatted_value}\")\n",
    "    \n",
    "    print(\"\\n\" + \"=\" * full_len + \"\\n\")\n",
    "    \n",
    "    # Print additional information\n",
    "    print(f\"ğŸ“ Files:\")\n",
    "    print(f\"   Input:  {input_path}\")\n",
    "    print(f\"   Output: {output_path}\")\n",
    "    \n",
    "    if results.get(\"studio_url\"):\n",
    "        print(f\"\\nğŸŒ AI Foundry Portal:\")\n",
    "        print(f\"   {results['studio_url']}\")\n",
    "    \n",
    "    print(\"\\n\" + \"=\" * full_len + \"\\n\")\n",
    "\n",
    "# ê²°ê³¼ í‘œì‹œ\n",
    "print_eval_results(results, eval_input_path, eval_output_path)\n",
    "\n",
    "print(\"ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:\")\n",
    "print(\"   1. AI Foundry Portalì—ì„œ ìƒì„¸ ê²°ê³¼ í™•ì¸\")\n",
    "print(\"   2. ì ìˆ˜ê°€ ë‚®ì€ í•­ëª© ë¶„ì„\")\n",
    "print(\"   3. Agent ë˜ëŠ” í”„ë¡¬í”„íŠ¸ ê°œì„ \")\n",
    "print(\"   4. ì¬í‰ê°€ ë° ë¹„êµ\")\n",
    "print(\"\\n\" + \"=\"*70)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e9eaac4b",
   "metadata": {},
   "source": [
    "## 15. Evaluation ìš”ì•½ (Evaluation Summary)\n",
    "\n",
    "### ì™„ë£Œëœ ì‘ì—…\n",
    "\n",
    "âœ… **Evaluation í™˜ê²½ ì„¤ì •**\n",
    "- azure-ai-evaluation íŒ¨í‚¤ì§€ ì„¤ì¹˜\n",
    "- í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ íŒŒì¼ ìƒì„± (eval-queries.json)\n",
    "\n",
    "âœ… **Agent Evaluation ì‹¤í–‰**\n",
    "- ë°°í¬ëœ Agentì— ëŒ€í•´ í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ì‹¤í–‰\n",
    "- ìš´ì˜ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (ì‹¤í–‰ ì‹œê°„, í† í° ì‚¬ìš©ëŸ‰)\n",
    "- 6ê°œì˜ evaluatorë¡œ í’ˆì§ˆ í‰ê°€ ìˆ˜í–‰\n",
    "- ê²°ê³¼ë¥¼ JSON íŒŒì¼ë¡œ ì €ì¥\n",
    "- AI Foundry Portalì— ê²°ê³¼ ì—…ë¡œë“œ\n",
    "\n",
    "âœ… **ê²°ê³¼ ë¶„ì„**\n",
    "- ìš´ì˜ ë©”íŠ¸ë¦­: ì„±ëŠ¥ ë° íš¨ìœ¨ì„±\n",
    "- ì„±ëŠ¥ ë©”íŠ¸ë¦­: ë„êµ¬ í˜¸ì¶œ, ì˜ë„ íŒŒì•…, ì§€ì‹œ ì¤€ìˆ˜\n",
    "- ì•ˆì „ì„± ë©”íŠ¸ë¦­: ì½”ë“œ ì·¨ì•½ì , ì½˜í…ì¸  ì•ˆì „ì„±, ê³µê²© ê°ì§€\n",
    "\n",
    "### Evaluation íŒŒì¼\n",
    "\n",
    "```\n",
    "evals/\n",
    "â”œâ”€â”€ eval-queries.json      # í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ (5ê°œ)\n",
    "â”œâ”€â”€ eval-input.jsonl       # Agent ì‹¤í–‰ ê²°ê³¼ + ë©”íŠ¸ë¦­\n",
    "â””â”€â”€ eval-output.json       # Evaluator ì ìˆ˜ ë° ìƒì„¸ ê²°ê³¼\n",
    "```\n",
    "\n",
    "### AI Foundry Portalì—ì„œ í™•ì¸\n",
    "\n",
    "**Evaluations íƒ­:**\n",
    "1. AI Foundry Portal (https://ai.azure.com) ì ‘ì†\n",
    "2. í”„ë¡œì íŠ¸ ì„ íƒ\n",
    "3. \"Evaluations\" ë˜ëŠ” \"í‰ê°€\" íƒ­ í´ë¦­\n",
    "4. \"foundry-agent-evaluation\" ê²°ê³¼ í™•ì¸\n",
    "\n",
    "**í™•ì¸ ê°€ëŠ¥í•œ ì •ë³´:**\n",
    "- ì „ì²´ ì ìˆ˜ ìš”ì•½ (í‰ê· , ìµœì†Œ, ìµœëŒ€)\n",
    "- ê° ì¿¼ë¦¬ë³„ ìƒì„¸ ì ìˆ˜\n",
    "- Evaluatorë³„ ë¶„ì„ ê²°ê³¼\n",
    "- ì‹œê°„ ê²½ê³¼ì— ë”°ë¥¸ ê°œì„  ì¶”ì \n",
    "\n",
    "### ë‹¤ìŒ ë‹¨ê³„\n",
    "\n",
    "**Evaluationì„ í™œìš©í•œ ê°œì„ :**\n",
    "\n",
    "1. **ì ìˆ˜ ë¶„ì„**\n",
    "   - ë‚®ì€ ì ìˆ˜ë¥¼ ë°›ì€ ì¿¼ë¦¬ í™•ì¸\n",
    "   - ì–´ë–¤ evaluatorì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ì§€ íŒŒì•…\n",
    "\n",
    "2. **Agent ê°œì„ **\n",
    "   - í”„ë¡¬í”„íŠ¸ ìˆ˜ì • (instructions)\n",
    "   - Tool ì¶”ê°€ ë˜ëŠ” ê°œì„ \n",
    "   - RAG ë°ì´í„° ë³´ê°•\n",
    "\n",
    "3. **ì¬í‰ê°€**\n",
    "   - ë™ì¼í•œ ì¿¼ë¦¬ë¡œ ì¬í‰ê°€\n",
    "   - ì ìˆ˜ ë¹„êµ ë° ê°œì„  í™•ì¸\n",
    "\n",
    "4. **CI/CD í†µí•©** (ì„ íƒì‚¬í•­)\n",
    "   - GitHub Actionsë¡œ ìë™ í‰ê°€\n",
    "   - PRë§ˆë‹¤ ì„±ëŠ¥ íšŒê·€ í…ŒìŠ¤íŠ¸\n",
    "   - [AI Agent Evaluation Action](https://github.com/microsoft/ai-agent-evals) ì‚¬ìš©\n",
    "\n",
    "### ì°¸ê³  ìë£Œ\n",
    "\n",
    "- [Azure AI Foundry Agent Evaluation](https://learn.microsoft.com/azure/ai-foundry/how-to/develop/agent-evaluate-sdk)\n",
    "- [Built-in Evaluators](https://learn.microsoft.com/azure/ai-foundry/how-to/develop/evaluate-sdk)\n",
    "- [Sample: get-started-with-ai-agents/evals](https://github.com/Azure-Samples/get-started-with-ai-agents/tree/main/evals)\n",
    "\n",
    "### ìµœì¢… ìš”ì•½\n",
    "\n",
    "ì¶•í•˜í•©ë‹ˆë‹¤! Agent Evaluationì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.\n",
    "\n",
    "**ë°°í¬ëœ ì‹œìŠ¤í…œ:**\n",
    "- âœ… Multi-Agent System (Main, Tool, Research)\n",
    "- âœ… MCP Server (ë‚ ì”¨ ë„êµ¬)\n",
    "- âœ… Application Analytics (ë©”íŠ¸ë¦­ ì¶”ì )\n",
    "- âœ… **Agent Evaluation (í’ˆì§ˆ í‰ê°€)** â† ì´ë²ˆ ì„¹ì…˜ì—ì„œ ì¶”ê°€\n",
    "\n",
    "ì´ì œ ë‹¤ìŒ ë…¸íŠ¸ë¶ìœ¼ë¡œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n",
    "- **Notebook 4**: Agent Framework Workflow (LangGraph ê¸°ë°˜)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fc97d932",
   "metadata": {},
   "source": [
    "## 17. Evaluation ê²°ê³¼ í™•ì¸ (View Evaluation Results)\n",
    "\n",
    "Evaluation ê²°ê³¼ë¥¼ í¬ë§·íŒ…í•˜ì—¬ í‘œì‹œí•©ë‹ˆë‹¤.\n",
    "\n",
    "### ê²°ê³¼ ë©”íŠ¸ë¦­\n",
    "\n",
    "**Operational Metrics (ìš´ì˜ ë©”íŠ¸ë¦­):**\n",
    "- `server-run-duration-in-seconds`: ì„œë²„ ì¸¡ ì‹¤í–‰ ì‹œê°„\n",
    "- `client-run-duration-in-seconds`: í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì‹¤í–‰ ì‹œê°„  \n",
    "- `completion-tokens`: ìƒì„±ëœ í† í° ìˆ˜\n",
    "- `prompt-tokens`: ì…ë ¥ í† í° ìˆ˜\n",
    "\n",
    "**Performance Metrics (ì„±ëŠ¥ ë©”íŠ¸ë¦­):**\n",
    "- `tool_call_accuracy.*`: ë„êµ¬ í˜¸ì¶œ ì •í™•ë„ ì ìˆ˜\n",
    "- `intent_resolution.*`: ì˜ë„ íŒŒì•… ì ìˆ˜\n",
    "- `task_adherence.*`: ì§€ì‹œì‚¬í•­ ì¤€ìˆ˜ ì ìˆ˜\n",
    "\n",
    "**Safety Metrics (ì•ˆì „ì„± ë©”íŠ¸ë¦­):**\n",
    "- `code_vulnerability.*`: ì½”ë“œ ì·¨ì•½ì  ì ìˆ˜\n",
    "- `content_safety.*`: ì½˜í…ì¸  ì•ˆì „ì„± ì ìˆ˜  \n",
    "- `indirect_attack.*`: ê°„ì ‘ ê³µê²© ê°ì§€ ì ìˆ˜\n",
    "\n",
    "> ğŸ’¡ **ì°¸ê³ **: ì ìˆ˜ê°€ ë†’ì„ìˆ˜ë¡ ì¢‹ìŠµë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ë©”íŠ¸ë¦­ì€ 0-5 ë˜ëŠ” 1-5 ë²”ìœ„ì…ë‹ˆë‹¤."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a2ae0c73",
   "metadata": {},
   "source": [
    "## 16. Agentì—ì„œ ì§ì ‘ Evaluation ì‹¤í–‰ (Run Agent Evaluation)\n",
    "\n",
    "ë°°í¬ëœ Agentì— ëŒ€í•´ evaluationì„ ì‹¤í–‰í•©ë‹ˆë‹¤.\n",
    "\n",
    "### Evaluation í”„ë¡œì„¸ìŠ¤\n",
    "\n",
    "1. **Agent ì¤€ë¹„**: ë°°í¬ëœ Agent ID/ì´ë¦„ í™•ì¸\n",
    "2. **ì¿¼ë¦¬ ì‹¤í–‰**: ê° í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ë¥¼ Agentì— ì „ì†¡í•˜ê³  ì‘ë‹µ ìˆ˜ì§‘\n",
    "3. **ë©”íŠ¸ë¦­ ìˆ˜ì§‘**: ì‹¤í–‰ ì‹œê°„, í† í° ì‚¬ìš©ëŸ‰ ë“± ìš´ì˜ ë©”íŠ¸ë¦­ ê¸°ë¡\n",
    "4. **Evaluation ì‹¤í–‰**: ë‚´ì¥ evaluatorë“¤ë¡œ ì‘ë‹µ í’ˆì§ˆ í‰ê°€\n",
    "5. **ê²°ê³¼ ì €ì¥**: JSON íŒŒì¼ë¡œ ì €ì¥ ë° AI Foundryì— ì—…ë¡œë“œ\n",
    "\n",
    "### Evaluators\n",
    "\n",
    "ì´ evaluationì—ì„œ ì‚¬ìš©í•˜ëŠ” evaluator:\n",
    "\n",
    "**Performance Evaluators:**\n",
    "- `ToolCallAccuracyEvaluator`: ë„êµ¬ í˜¸ì¶œ ì •í™•ë„\n",
    "- `IntentResolutionEvaluator`: ì˜ë„ íŒŒì•… ì •í™•ë„\n",
    "- `TaskAdherenceEvaluator`: ì§€ì‹œì‚¬í•­ ì¤€ìˆ˜ë„\n",
    "\n",
    "**Safety Evaluators:**\n",
    "- `CodeVulnerabilityEvaluator`: ì½”ë“œ ë³´ì•ˆ ì·¨ì•½ì \n",
    "- `ContentSafetyEvaluator`: ì½˜í…ì¸  ì•ˆì „ì„±\n",
    "- `IndirectAttackEvaluator`: ê°„ì ‘ ê³µê²© ê°ì§€\n",
    "\n",
    "### ì‹¤í–‰ ì‹œê°„\n",
    "\n",
    "- ê° ì¿¼ë¦¬ ì‹¤í–‰: ~5-10ì´ˆ\n",
    "- Evaluation: ~30-60ì´ˆ\n",
    "- ì „ì²´ ì†Œìš” ì‹œê°„: ~2-3ë¶„"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "ee6bc08e",
   "metadata": {},
   "source": [
    "## 14. Evaluation í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬ ìƒì„± (Create Evaluation Test Queries)\n",
    "\n",
    "í…ŒìŠ¤íŠ¸ìš© ì¿¼ë¦¬ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤. ê° ì¿¼ë¦¬ëŠ” Agentì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.\n",
    "\n",
    "**ì¿¼ë¦¬ ì¢…ë¥˜:**\n",
    "1. **ì¼ë°˜ ëŒ€í™”**: Main Agentì˜ ê¸°ë³¸ ëŒ€í™” ê¸°ëŠ¥\n",
    "2. **Tool ì‚¬ìš©**: Tool Agentì˜ MCP ë„êµ¬ í˜¸ì¶œ (ë‚ ì”¨ ì¡°íšŒ)\n",
    "3. **RAG ê²€ìƒ‰**: Research Agentì˜ ì§€ì‹ ë² ì´ìŠ¤ ê²€ìƒ‰\n",
    "\n",
    "**Ground Truth (ì •ë‹µ ì°¸ê³ ):**\n",
    "- ì¼ë¶€ evaluatorëŠ” ground-truthë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹µë³€ í’ˆì§ˆì„ í‰ê°€\n",
    "- ì„ íƒì‚¬í•­ì´ì§€ë§Œ, ë” ì •í™•í•œ í‰ê°€ë¥¼ ìœ„í•´ í¬í•¨ ê¶Œì¥"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d5d558af",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Azure AI Evaluation íŒ¨í‚¤ì§€ ì„¤ì¹˜\n",
    "print(\"=== Installing Azure AI Evaluation Package ===\\n\")\n",
    "\n",
    "result = subprocess.run(\n",
    "    [sys.executable, \"-m\", \"pip\", \"install\", \"-q\", \"azure-ai-evaluation\"],\n",
    "    capture_output=True,\n",
    "    text=True\n",
    ")\n",
    "\n",
    "if result.returncode == 0:\n",
    "    print(\"âœ… azure-ai-evaluation installed successfully\")\n",
    "else:\n",
    "    print(f\"âš ï¸  Installation warning: {result.stderr}\")\n",
    "    print(\"   Proceeding anyway...\")\n",
    "\n",
    "print(\"\\n\" + \"=\"*50)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": ".venv (3.12.12)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.12"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
